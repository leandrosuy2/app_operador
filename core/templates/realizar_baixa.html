{% extends 'base.html' %}

{% block content %}
<div class="container mt-5">
  <h1 class="text-center">Realizar Baixa</h1>

  <span>Nome do cliente: <b>{{ titulo.devedor.nome }}</b></span>

  <form method="post"
        action="{% url 'realizar_baixa' titulo.id %}"
        class="mt-4"
        enctype="multipart/form-data">
    {% csrf_token %}

    <!-- Valor da Dívida -->
    <div class="row mb-3">
      <label class="col-sm-4 col-form-label">Valor da Dívida</label>
      <div class="col-sm-8">
        <span id="valor_divida_exibicao"><b>R$ {{ titulo.valor|floatformat:2 }}</b></span>
        <input type="hidden" id="valor_divida" name="valor_divida" value="{{ titulo.valor|floatformat:2 }}">
      </div>
    </div>

    <!-- Data de Vencimento -->
    <div class="row mb-3">
      <label class="col-sm-4 col-form-label">Data de Vencimento</label>
      <div class="col-sm-8">
        <span id="data_vencimento_exibicao"><b>{{ data_vencimento_formatada }}</b></span>
        <input type="hidden" id="data_vencimento" name="data_vencimento" value="{{ data_vencimento_formatada }}">
      </div>
    </div>

    <!-- Juros Totais -->
    <div class="row mb-3">
      <label class="col-sm-4 col-form-label">Juros Totais</label>
      <div class="col-sm-8">
        <span><b>R$ {{ juros_totais|floatformat:2 }}</b></span>
        <input type="hidden" id="valor_juros" name="valor_juros" value="{{ juros_totais|floatformat:2 }}">
      </div>
    </div>

    <!-- Tipo de Baixa (fixo como Quitação; se quiser alternar, troque por <select>) -->
    <div class="row mb-3">
      <label class="col-sm-4 col-form-label">Tipo de Baixa</label>
      <div class="col-sm-8">
        <input type="text" id="tipo_baixa" name="tipo_baixa" value="Quitação" class="form-control" readonly>
      </div>
    </div>

    <!-- Campos para Quitação -->
    <div id="quitacao_fields">
      <div class="row mb-3">
        <label class="col-sm-4 col-form-label">Valor Quitação</label>
        <div class="col-sm-8">
          <input type="number" step="0.01" id="valor_quitacao" name="valor_quitacao" class="form-control" required>
        </div>
      </div>

      <div class="row mb-3">
        <label class="col-sm-4 col-form-label">Data do Pagamento</label>
        <div class="col-sm-8">
          <input type="date" id="data_pagamento" name="data_pagamento" class="form-control" required>
        </div>
      </div>

      <!-- Forma de Pagamento -->
      <div class="row mb-3">
        <label class="col-sm-4 col-form-label">Forma de Pagamento</label>
        <div class="col-sm-8">
          <select id="forma_pagamento" name="forma_pagamento" class="form-control" required>
            <option value="0">Pix</option>
            <option value="1">Dinheiro</option>
            <option value="2">Cartão de Débito</option>
            <option value="3">Cartão de Crédito</option>
            <option value="4">Cheque</option>
            <option value="5">Depósito em Conta</option>
            <option value="6">Pagamento na Loja</option>
            <option value="7">Boleto Bancário</option>
            <option value="8">Duplicata</option>
            <option value="9">Recebimento pelo credor</option>
            <option value="10">Óbito confirmado</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Campos para Negociação (fica oculto pois tipo está fixo em Quitação) -->
    <div id="negociacao_fields" style="display:none;">
      <div class="row mb-3">
        <label class="col-sm-4 col-form-label">Desconto nos Juros (%)</label>
        <div class="col-sm-8">
          <input type="number" step="0.01" id="desconto_juros_percentual" name="desconto_juros_percentual" class="form-control">
        </div>
      </div>

      <div class="row mb-3">
        <label class="col-sm-4 col-form-label">Valor da dívida com desconto nos Juros</label>
        <div class="col-sm-8">
          <input type="number" step="0.01" id="valor_total_com_juros" name="valor_total_com_juros" class="form-control" readonly>
        </div>
      </div>

      <div class="row mb-3">
        <label class="col-sm-4 col-form-label">Valor dos Juros com Desconto</label>
        <div class="col-sm-8">
          <input type="number" step="0.01" id="valor_juros_com_desconto" class="form-control" readonly>
        </div>
      </div>

      <div class="row mb-3">
        <label class="col-sm-4 col-form-label">Entrada</label>
        <div class="col-sm-8">
          <input type="number" step="0.01" id="entrada" name="entrada" class="form-control">
        </div>
      </div>

      <div class="row mb-3">
        <label class="col-sm-4 col-form-label">Quantidade de Parcelas</label>
        <div class="col-sm-8">
          <input type="number" name="qtde_prc" id="qtde_prc" class="form-control" min="1">
        </div>
      </div>

      <input type="number" step="0.01" id="valor_por_parcela" name="valor_por_parcela" class="form-control" hidden readonly>

      <div class="row mb-3">
        <label class="col-sm-4 col-form-label">Data Entrada</label>
        <div class="col-sm-8">
          <input type="date" name="data_entrada" id="data_entrada" class="form-control">
        </div>
      </div>

      <div class="row mb-3">
        <label class="col-sm-4 col-form-label">Vencimento Primeira Parcela</label>
        <div class="col-sm-8">
          <input type="date" name="venc_primeira_parcela" id="venc_primeira_parcela" class="form-control">
        </div>
      </div>

      <div class="row mb-3">
        <label class="col-sm-4 col-form-label">Parcelas</label>
        <div class="col-sm-8">
          <table class="table table-bordered mb-0">
            <thead>
              <tr>
                <th>Parcela</th>
                <th>Data Vencimento</th>
                <th>Valor</th>
              </tr>
            </thead>
            <tbody id="parcelas_table_body"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Comprovantes -->
    <div class="row mb-3">
      <label class="col-sm-4 col-form-label">Comprovantes (PDF/Imagem)</label>
      <div class="col-sm-8">
        <input type="file"
               name="comprovantes"
               id="comprovantes"
               class="form-control"
               accept=".pdf,image/*"
               multiple>
        <small class="text-muted">Você pode anexar mais de um arquivo (máx. 10MB cada; formatos: PDF/JPG/PNG/WEBP).</small>
        <div id="comprovantesPreview" class="small mt-2"></div>
      </div>
    </div>

{% if titulo.comprovante %}
<div class="row mb-3">
  <label class="col-sm-4 col-form-label">Já anexado</label>
  <div class="col-sm-8">
    <a href="{{ titulo.comprovante.url }}" target="_blank" rel="noopener">
      {{ titulo.comprovante.name|cut:"comprovantes/" }}
    </a>
  </div>
</div>
{% endif %}


    <!-- Botões -->
    <div class="text-center">
      <button type="submit" class="btn btn-success">Salvar Baixa</button>
      <a href="{% url 'titulos_listar' %}" class="btn btn-secondary">Cancelar</a>
    </div>
  </form>
</div>

<!-- JS regras (negociação/parcelas) -->
<script>
  document.getElementById('tipo_baixa').addEventListener('change', function () {
    const tipoBaixa = this.value;
    document.getElementById('quitacao_fields').style.display = tipoBaixa === 'Quitação' ? 'block' : 'none';
    document.getElementById('negociacao_fields').style.display = tipoBaixa === 'Negociação' ? 'block' : 'none';
  });

  document.getElementById('desconto_juros_percentual').addEventListener('input', calcularValores);
  document.getElementById('qtde_prc').addEventListener('input', atualizarParcelas);
  document.getElementById('entrada').addEventListener('input', atualizarParcelas);
  document.getElementById('venc_primeira_parcela').addEventListener('change', atualizarParcelas);

  function calcularValores() {
    const valorDivida = parseFloat(document.getElementById('valor_divida').value) || 0;
    const jurosTotais = parseFloat(document.getElementById('valor_juros').value) || 0;
    const descontoPercentual = parseFloat(document.getElementById('desconto_juros_percentual').value) || 0;

    const desconto = (descontoPercentual / 100) * jurosTotais;
    const valorJurosComDesconto = jurosTotais - desconto;
    const valorTotalComJuros = valorDivida + valorJurosComDesconto;

    document.getElementById('valor_juros_com_desconto').value = valorJurosComDesconto.toFixed(2);
    document.getElementById('valor_total_com_juros').value = valorTotalComJuros.toFixed(2);

    atualizarParcelas();
  }

  function atualizarParcelas() {
    const valorTotalComJuros = parseFloat(document.getElementById('valor_total_com_juros').value) || 0;
    const entrada = parseFloat(document.getElementById('entrada').value) || 0;
    const qtdeParc = parseInt(document.getElementById('qtde_prc').value) || 0;
    const vencPrimeiraParcela = document.getElementById('venc_primeira_parcela').value;

    if (!vencPrimeiraParcela || qtdeParc <= 0) return;

    const parcelaValor = ((valorTotalComJuros - entrada) / qtdeParc).toFixed(2);
    document.getElementById('valor_por_parcela').value = parcelaValor;

    const tabelaBody = document.getElementById('parcelas_table_body');
    tabelaBody.innerHTML = '';

    const dataInicio = new Date(vencPrimeiraParcela);
    for (let i = 0; i < qtdeParc; i++) {
      const dataParcela = new Date(dataInicio);
      dataParcela.setMonth(dataParcela.getMonth() + i);

      const row = `<tr>
          <td>${i + 1}</td>
          <td>${dataParcela.toLocaleDateString('pt-BR')}</td>
          <td>R$ ${parcelaValor}</td>
        </tr>`;
      tabelaBody.innerHTML += row;
    }
  }
</script>

<!-- JS: validação e pré-visualização de anexos -->
<script>
  (function () {
    const input = document.getElementById('comprovantes');
    const preview = document.getElementById('comprovantesPreview');
    const MAX = 10 * 1024 * 1024; // 10MB
    const ALLOWED = ['application/pdf','image/jpeg','image/png','image/webp','image/heic'];

    input.addEventListener('change', function () {
      preview.innerHTML = '';
      if (!this.files || !this.files.length) return;

      const rejeitados = [];
      const linhas = [];

      Array.from(this.files).forEach(f => {
        const okTipo = !f.type || ALLOWED.includes(f.type.toLowerCase()); // alguns browsers não setam type
        const okSize = !f.size || f.size <= MAX;

        if (!okTipo || !okSize) {
          rejeitados.push(`${f.name} ${!okTipo ? '(tipo não permitido)' : ''} ${!okSize ? '(>10MB)' : ''}`.trim());
          return;
        }
        const kb = (f.size ? (f.size/1024).toFixed(1) + ' KB' : '');
        linhas.push(`• ${f.name} ${kb ? '— ' + kb : ''}`);
      });

      if (linhas.length) {
        preview.innerHTML = `<div>Selecionados:<br>${linhas.join('<br>')}</div>`;
      }
      if (rejeitados.length) {
        alert('Alguns arquivos foram rejeitados:\n' + rejeitados.join('\n'));
      }
      // Se todos foram rejeitados, limpa input
      if (!linhas.length) this.value = '';
    });
  })();
</script>

<!-- Validação mínima no submit se alternar para negociação -->
<script>
  document.querySelector('form').addEventListener('submit', function (event) {
    const tipoBaixa = document.getElementById('tipo_baixa').value;
    if (tipoBaixa === 'Negociação') {
      const entrada = document.getElementById('entrada').value;
      const qtdePrc = document.getElementById('qtde_prc').value;
      const vencPrimeiraParcela = document.getElementById('venc_primeira_parcela').value;

      if (!entrada || !qtdePrc || !vencPrimeiraParcela) {
        event.preventDefault();
        alert("Preencha todos os campos necessários para Negociação.");
        return;
      }
    }
  });
</script>
{% endblock %}
