{% extends 'base.html' %}
{% load custom_filters l10n %}
{% block content %}

<style>
  /* ========== RESPONSIVIDADE GERAL ========== */
  .detalhes-container {
    padding: 0.5rem;
  }

  @media (min-width: 576px) {
    .detalhes-container {
      padding: 0.75rem;
    }
  }

  @media (min-width: 768px) {
    .detalhes-container {
      padding: 1rem;
    }
  }

  /* ========== TÍTULO E AÇÕES ========== */
  .detalhes-header {
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
    gap: 0.75rem;
  }

  .detalhes-header h1 {
    font-size: 1.25rem;
    font-weight: 700;
    margin: 0;
    width: 100%;
    text-align: center;
  }

  @media (min-width: 576px) {
    .detalhes-header h1 {
      font-size: 1.5rem;
      width: auto;
      text-align: left;
    }
  }

  @media (min-width: 768px) {
    .detalhes-header h1 {
      font-size: 1.75rem;
    }
  }

  .detalhes-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    width: 100%;
    justify-content: center;
  }

  @media (min-width: 576px) {
    .detalhes-actions {
      width: auto;
      justify-content: flex-end;
    }
  }

  .detalhes-actions .btn {
    font-size: 0.75rem;
    padding: 0.4rem 0.75rem;
    white-space: nowrap;
  }

  @media (min-width: 576px) {
    .detalhes-actions .btn {
      font-size: 0.875rem;
      padding: 0.5rem 1rem;
    }
  }

  @media (min-width: 768px) {
    .detalhes-actions .btn {
      font-size: 1rem;
      padding: 0.6rem 1.25rem;
    }
  }

  /* ========== CARDS ========== */
  .detalhes-card {
    margin-bottom: 1rem;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
  }

  .detalhes-card .card-header {
    padding: 0.75rem 1rem;
    font-size: 0.9rem;
    font-weight: 600;
  }

  @media (min-width: 576px) {
    .detalhes-card .card-header {
      padding: 1rem 1.25rem;
      font-size: 1rem;
    }
  }

  @media (min-width: 768px) {
    .detalhes-card .card-header {
      padding: 1.25rem 1.5rem;
      font-size: 1.25rem;
    }
  }

  .detalhes-card .card-header h3 {
    font-size: 1rem;
    margin: 0;
  }

  @media (min-width: 576px) {
    .detalhes-card .card-header h3 {
      font-size: 1.1rem;
    }
  }

  @media (min-width: 768px) {
    .detalhes-card .card-header h3 {
      font-size: 1.25rem;
    }
  }

  .detalhes-card .card-body {
    padding: 0.75rem;
  }

  @media (min-width: 576px) {
    .detalhes-card .card-body {
      padding: 1rem;
    }
  }

  @media (min-width: 768px) {
    .detalhes-card .card-body {
      padding: 1.25rem;
    }
  }

  /* ========== FORMULÁRIOS ========== */
  .detalhes-card .form-label {
    font-size: 0.8rem;
    font-weight: 600;
    margin-bottom: 0.25rem;
  }

  @media (min-width: 576px) {
    .detalhes-card .form-label {
      font-size: 0.875rem;
    }
  }

  .detalhes-card .form-control,
  .detalhes-card .form-select {
    font-size: 0.8rem;
    padding: 0.4rem 0.6rem;
  }

  @media (min-width: 576px) {
    .detalhes-card .form-control,
    .detalhes-card .form-select {
      font-size: 0.875rem;
      padding: 0.5rem 0.75rem;
    }
  }

  /* ========== TELEFONES ========== */
  .telefone-group {
    margin-bottom: 1rem;
  }

  .telefone-group .d-flex {
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .telefone-group .form-control {
    flex: 1;
    min-width: 150px;
  }

  .telefone-group .btn-group {
    flex-shrink: 0;
  }

  .telefone-group .btn {
    font-size: 0.7rem;
    padding: 0.3rem 0.5rem;
  }

  @media (min-width: 576px) {
    .telefone-group .btn {
      font-size: 0.75rem;
      padding: 0.35rem 0.6rem;
    }
  }

  /* ========== TABELAS RESPONSIVAS ========== */
  .table-responsive-wrapper {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    margin-bottom: 1rem;
    border-radius: 4px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  }

  .detalhes-table {
    width: 100%;
    min-width: 900px;
    font-size: 0.7rem;
    margin: 0;
  }

  @media (min-width: 576px) {
    .detalhes-table {
      min-width: 1000px;
      font-size: 0.75rem;
    }
  }

  @media (min-width: 768px) {
    .detalhes-table {
      min-width: 100%;
      font-size: 0.8rem;
    }
  }

  .detalhes-table thead th {
    font-size: 0.65rem;
    padding: 0.5rem 0.4rem;
    white-space: nowrap;
    background: #212529;
    color: white;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.3px;
  }

  @media (min-width: 576px) {
    .detalhes-table thead th {
      font-size: 0.7rem;
      padding: 0.6rem 0.5rem;
    }
  }

  @media (min-width: 768px) {
    .detalhes-table thead th {
      font-size: 0.75rem;
      padding: 0.75rem;
    }
  }

  .detalhes-table tbody td {
    padding: 0.5rem 0.4rem;
    vertical-align: middle;
    font-size: 0.7rem;
  }

  @media (min-width: 576px) {
    .detalhes-table tbody td {
      padding: 0.6rem 0.5rem;
      font-size: 0.75rem;
    }
  }

  @media (min-width: 768px) {
    .detalhes-table tbody td {
      padding: 0.75rem;
      font-size: 0.8rem;
    }
  }

  .detalhes-table .btn {
    font-size: 0.65rem;
    padding: 0.25rem 0.45rem;
    margin: 0.15rem;
  }

  @media (min-width: 576px) {
    .detalhes-table .btn {
      font-size: 0.7rem;
      padding: 0.3rem 0.5rem;
    }
  }

  @media (min-width: 768px) {
    .detalhes-table .btn {
      font-size: 0.75rem;
      padding: 0.35rem 0.6rem;
    }
  }

  /* ========== PROPOSTA AO CREDOR ========== */
  .proposta-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 0.75rem;
  }

  @media (min-width: 576px) {
    .proposta-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (min-width: 768px) {
    .proposta-grid {
      grid-template-columns: repeat(3, 1fr);
    }
  }

  @media (min-width: 992px) {
    .proposta-grid {
      grid-template-columns: repeat(4, 1fr);
    }
  }

  .proposta-grid .col-12 {
    grid-column: 1 / -1;
  }

  /* ========== MODAIS ========== */
  .modal-dialog {
    margin: 0.5rem;
    max-width: calc(100% - 1rem);
  }

  @media (min-width: 576px) {
    .modal-dialog {
      margin: 1.75rem auto;
      max-width: 500px;
    }
  }

  @media (min-width: 768px) {
    .modal-dialog.modal-lg {
      max-width: 800px;
    }
  }

  /* ========== FOLLOWUP ========== */
  .followup-entry {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }
  
  .followup-header {
    color: #495057;
    margin-bottom: 8px;
    font-size: 0.8rem;
  }

  @media (min-width: 576px) {
    .followup-header {
      font-size: 0.85rem;
    }
  }

  @media (min-width: 768px) {
    .followup-header {
      font-size: 0.9rem;
    }
  }
  
  .followup-content {
    color: #212529;
    line-height: 1.6;
    white-space: pre-line;
    font-size: 0.8rem;
  }

  @media (min-width: 576px) {
    .followup-content {
      font-size: 0.85rem;
    }
  }

  @media (min-width: 768px) {
    .followup-content {
      font-size: 0.9rem;
    }
  }
  
  .followup-content br {
    margin-bottom: 4px;
  }

  /* ========== ALERTAS ========== */
  .alert {
    font-size: 0.8rem;
    padding: 0.75rem 1rem;
  }

  @media (min-width: 576px) {
    .alert {
      font-size: 0.875rem;
      padding: 1rem 1.25rem;
    }
  }

  /* ========== BADGES ========== */
  .badge {
    font-size: 0.6rem;
    padding: 0.2rem 0.4rem;
  }

  @media (min-width: 576px) {
    .badge {
      font-size: 0.65rem;
      padding: 0.25rem 0.45rem;
    }
  }

  @media (min-width: 768px) {
    .badge {
      font-size: 0.7rem;
      padding: 0.3rem 0.5rem;
    }
  }
</style>

<div class="container-fluid detalhes-container">

  <!-- ====== CONTEXTO EM DATASETS (para JS usar com segurança) ====== -->
  <div id="ctx"
       data-user="{{ request.user.get_full_name|default:request.user.first_name|default:request.user.username|escapejs }}"
       data-devedor="{{ devedor.nome|default_if_none:''|escapejs }}"
       data-empresa-fantasia="{{ empresa.nome_fantasia|default_if_none:''|escapejs }}"
       data-empresa-razao="{{ empresa.razao_social|default_if_none:''|escapejs }}"
       data-chave-pix="{{ empresa.banco|default_if_none:''|escapejs }}">
  </div>

  <!-- TÍTULO + AÇÕES -->
  <div class="d-flex justify-content-between align-items-center detalhes-header">
    <h1>Detalhes do Devedor</h1>
    <div class="detalhes-actions">
      {% if titulos_entrada or titulos_associados %}
        <a href="{% url 'proximo_cliente' titulo.id %}" class="btn btn-primary">
          <i class="fas fa-arrow-right"></i> <span class="d-none d-sm-inline">Próximo Cliente</span>
        </a>
      {% endif %}
      <a href="{% url 'realizar_acordo' titulo.id %}" class="btn btn-success">
        <i class="fas fa-handshake"></i> <span class="d-none d-sm-inline">Gerar Acordo</span>
      </a>
      <button id="btn-atualizar-devedor" class="btn btn-info">
        <i class="fas fa-sync-alt"></i> <span class="d-none d-sm-inline">Atualizar</span>
      </button>
    </div>
  </div>

  {% if messages %}
  <div class="mt-3">
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  </div>
  {% endif %}

  {% if obito_info %}
  <div class="alert {% if obito_info.deceased %}alert-danger{% else %}alert-success{% endif %} d-flex align-items-center mt-3" role="alert">
    <i class="bi bi-activity me-2"></i>
    {% if obito_info.deceased %}<strong>TITULAR FALECIDO.</strong>{% else %}<strong>Sem registro de óbito para este CPF.</strong>{% endif %}
    {% if obito_info.date %}<span class="ms-2">• Data: {{ obito_info.date }}</span>{% endif %}
    {% if obito_info.source %}<span class="ms-2">• Fonte: {{ obito_info.source }}</span>{% endif %}
    {% if obito_info.cached %}<span class="ms-2 text-muted">(cache)</span>{% endif %}
  </div>
  {% endif %}

  <!-- =================== DADOS DO DEVEDOR =================== -->
  <div class="card detalhes-card">
    <div class="card-header bg-primary text-white"><h3>Informações do Devedor</h3></div>
    <div class="card-body">
      <form method="post" action="">
        {% csrf_token %}
        <div class="row g-2">
          <div class="col-12 col-md-6"><label class="form-label"><strong>Nome:</strong></label><p class="form-control-plaintext mb-0">{{ devedor.nome }}</p></div>
          <div class="col-12 col-md-6"><label class="form-label"><strong>CPF:</strong></label><p class="form-control-plaintext mb-0">{{ devedor.cpf }}</p></div>
          <div class="col-12 col-md-6"><label class="form-label"><strong>CNPJ:</strong></label><p class="form-control-plaintext mb-0">{{ devedor.cnpj }}</p></div>
          <div class="col-12 col-md-6"><label class="form-label"><strong>Nome da Mãe:</strong></label><p class="form-control-plaintext mb-0">{{ devedor.nome_mae }}</p></div>
          <div class="col-12 col-md-6"><label class="form-label"><strong>Credor:</strong></label><p class="form-control-plaintext mb-0">{{ empresa.nome_fantasia|default:empresa.razao_social }}</p></div>
        </div>

        <h4 class="mt-3 mb-3" style="font-size: 1rem;">Telefones</h4>
        <div class="row g-2">

          <div class="card mb-3">
            <div class="card-header"><strong>Legenda</strong></div>
            <div class="card-body">
              <ul class="list-unstyled mb-0">
                <li class="d-flex align-items-center mb-2"><i class="fas fa-check-circle text-success me-2"></i>✔ Telefone válido</li>
                <li class="d-flex align-items-center mb-2"><i class="fas fa-times-circle text-danger me-2"></i>✖ Telefone inválido</li>
                <li class="d-flex align-items-center"><i class="fas fa-question-circle text-secondary me-2"></i>? Telefone não verificado</li>
              </ul>
            </div>
          </div>

          <!-- Telefone 1 -->
          <div class="col-12 col-md-6 telefone-group">
            <label for="telefone1" class="form-label">Telefone 1</label>
            <div class="d-flex align-items-center flex-wrap gap-1">
              <input type="text" name="telefone1" id="telefone1" class="form-control 
                {% if devedor.telefone1_valido == 'SIM' %}status-valid{% elif devedor.telefone1_valido == 'NÃO' %}status-invalid{% else %}status-unknown{% endif %}" 
                value="{{ devedor.telefone1|default:'' }}">
              <button type="button" class="btn btn-success btn-sm" title="Abrir no WhatsApp"
                      data-whats="{{ devedor.telefone1|clean_phone_number }}" onclick="abrirModalWhats(this)">
                <i class="bi bi-whatsapp"></i> <span class="d-none d-sm-inline">WhatsApp</span>
              </button>
              <input type="hidden" name="telefone1_valido" id="telefone1_valido" value="{{ devedor.telefone1_valido|default:'NAO VERIFICADO' }}">
              <div class="btn-group">
                <button type="button" class="btn btn-success btn-sm {% if devedor.telefone1_valido == 'SIM' %}active{% endif %}" onclick="updateValidationStatus('telefone1', 'SIM')"><i class="fas fa-check-circle"></i></button>
                <button type="button" class="btn btn-danger btn-sm {% if devedor.telefone1_valido == 'NÃO' %}active{% endif %}" onclick="updateValidationStatus('telefone1', 'NÃO')"><i class="fas fa-times-circle"></i></button>
                <button type="button" class="btn btn-secondary btn-sm {% if devedor.telefone1_valido == 'NAO VERIFICADO' %}active{% endif %}" onclick="updateValidationStatus('telefone1', 'NAO VERIFICADO')"><i class="fas fa-question-circle"></i></button>
              </div>
            </div>
          </div>

          <!-- Telefone 2 -->
          <div class="col-12 col-md-6 telefone-group">
            <label for="telefone2" class="form-label">Telefone 2</label>
            <div class="d-flex align-items-center flex-wrap gap-1">
              <input type="text" name="telefone2" id="telefone2" class="form-control 
                {% if devedor.telefone2_valido == 'SIM' %}status-valid{% elif devedor.telefone2_valido == 'NÃO' %}status-invalid{% else %}status-unknown{% endif %}" 
                value="{{ devedor.telefone2|default:'' }}">
              <button type="button" class="btn btn-success btn-sm" title="Abrir no WhatsApp"
                      data-whats="{{ devedor.telefone2|clean_phone_number }}" onclick="abrirModalWhats(this)">
                <i class="bi bi-whatsapp"></i> <span class="d-none d-sm-inline">WhatsApp</span>
              </button>
              <input type="hidden" name="telefone2_valido" id="telefone2_valido" value="{{ devedor.telefone2_valido|default:'NAO VERIFICADO' }}">
              <div class="btn-group">
                <button type="button" class="btn btn-success btn-sm {% if devedor.telefone2_valido == 'SIM' %}active{% endif %}" onclick="updateValidationStatus('telefone2', 'SIM')"><i class="fas fa-check-circle"></i></button>
                <button type="button" class="btn btn-danger btn-sm {% if devedor.telefone2_valido == 'NÃO' %}active{% endif %}" onclick="updateValidationStatus('telefone2', 'NÃO')"><i class="fas fa-times-circle"></i></button>
                <button type="button" class="btn btn-secondary btn-sm {% if devedor.telefone2_valido == 'NAO VERIFICADO' %}active{% endif %}" onclick="updateValidationStatus('telefone2', 'NAO VERIFICADO')"><i class="fas fa-question-circle"></i></button>
              </div>
            </div>
          </div>

          <!-- Telefone 3 -->
          <div class="col-12 col-md-6 telefone-group">
            <label for="telefone3" class="form-label">Telefone 3</label>
            <div class="d-flex align-items-center flex-wrap gap-1">
              <input type="text" name="telefone3" id="telefone3" class="form-control 
                {% if devedor.telefone3_valido == 'SIM' %}status-valid{% elif devedor.telefone3_valido == 'NÃO' %}status-invalid{% else %}status-unknown{% endif %}" 
                value="{{ devedor.telefone3|default:'' }}">
              <button type="button" class="btn btn-success btn-sm" title="Abrir no WhatsApp"
                      data-whats="{{ devedor.telefone3|clean_phone_number }}" onclick="abrirModalWhats(this)">
                <i class="bi bi-whatsapp"></i> <span class="d-none d-sm-inline">WhatsApp</span>
              </button>
              <input type="hidden" name="telefone3_valido" id="telefone3_valido" value="{{ devedor.telefone3_valido|default:'NAO VERIFICADO' }}">
              <div class="btn-group">
                <button type="button" class="btn btn-success btn-sm {% if devedor.telefone3_valido == 'SIM' %}active{% endif %}" onclick="updateValidationStatus('telefone3', 'SIM')"><i class="fas fa-check-circle"></i></button>
                <button type="button" class="btn btn-danger btn-sm {% if devedor.telefone3_valido == 'NÃO' %}active{% endif %}" onclick="updateValidationStatus('telefone3', 'NÃO')"><i class="fas fa-times-circle"></i></button>
                <button type="button" class="btn btn-secondary btn-sm {% if devedor.telefone3_valido == 'NAO VERIFICADO' %}active{% endif %}" onclick="updateValidationStatus('telefone3', 'NAO VERIFICADO')"><i class="fas fa-question-circle"></i></button>
              </div>
            </div>
          </div>

          <!-- Telefone 4 -->
          <div class="col-12 col-md-6 telefone-group">
            <label for="telefone4" class="form-label">Telefone 4</label>
            <div class="d-flex align-items-center flex-wrap gap-1">
              <input type="text" name="telefone4" id="telefone4" class="form-control 
                {% if devedor.telefone4_valido == 'SIM' %}status-valid{% elif devedor.telefone4_valido == 'NÃO' %}status-invalid{% else %}status-unknown{% endif %}" 
                value="{{ devedor.telefone4|default:'' }}">
              <button type="button" class="btn btn-success btn-sm" title="Abrir no WhatsApp"
                      data-whats="{{ devedor.telefone4|clean_phone_number }}" onclick="abrirModalWhats(this)">
                <i class="bi bi-whatsapp"></i> <span class="d-none d-sm-inline">WhatsApp</span>
              </button>
              <input type="hidden" name="telefone4_valido" id="telefone4_valido" value="{{ devedor.telefone4_valido|default:'NAO VERIFICADO' }}">
              <div class="btn-group">
                <button type="button" class="btn btn-success btn-sm {% if devedor.telefone4_valido == 'SIM' %}active{% endif %}" onclick="updateValidationStatus('telefone4', 'SIM')"><i class="fas fa-check-circle"></i></button>
                <button type="button" class="btn btn-danger btn-sm {% if devedor.telefone4_valido == 'NÃO' %}active{% endif %}" onclick="updateValidationStatus('telefone4', 'NÃO')"><i class="fas fa-times-circle"></i></button>
                <button type="button" class="btn btn-secondary btn-sm {% if devedor.telefone4_valido == 'NAO VERIFICADO' %}active{% endif %}" onclick="updateValidationStatus('telefone4', 'NAO VERIFICADO')"><i class="fas fa-question-circle"></i></button>
              </div>
            </div>
          </div>

          <!-- Telefone 5 -->
          <div class="col-12 col-md-6 telefone-group">
            <label for="telefone5" class="form-label">Telefone 5</label>
            <div class="d-flex align-items-center flex-wrap gap-1">
              <input type="text" name="telefone5" id="telefone5" class="form-control 
                {% if devedor.telefone5_valido == 'SIM' %}status-valid{% elif devedor.telefone5_valido == 'NÃO' %}status-invalid{% else %}status-unknown{% endif %}" 
                value="{{ devedor.telefone5|default:'' }}">
              <button type="button" class="btn btn-success btn-sm" title="Abrir no WhatsApp"
                      data-whats="{{ devedor.telefone5|clean_phone_number }}" onclick="abrirModalWhats(this)">
                <i class="bi bi-whatsapp"></i> <span class="d-none d-sm-inline">WhatsApp</span>
              </button>
              <input type="hidden" name="telefone5_valido" id="telefone5_valido" value="{{ devedor.telefone5_valido|default:'NAO VERIFICADO' }}">
              <div class="btn-group">
                <button type="button" class="btn btn-success btn-sm {% if devedor.telefone5_valido == 'SIM' %}active{% endif %}" onclick="updateValidationStatus('telefone5', 'SIM')"><i class="fas fa-check-circle"></i></button>
                <button type="button" class="btn btn-danger btn-sm {% if devedor.telefone5_valido == 'NÃO' %}active{% endif %}" onclick="updateValidationStatus('telefone5', 'NÃO')"><i class="fas fa-times-circle"></i></button>
                <button type="button" class="btn btn-secondary btn-sm {% if devedor.telefone5_valido == 'NAO VERIFICADO' %}active{% endif %}" onclick="updateValidationStatus('telefone5', 'NAO VERIFICADO')"><i class="fas fa-question-circle"></i></button>
              </div>
            </div>
          </div>

          <!-- Telefone 6 -->
          <div class="col-12 col-md-6 telefone-group">
            <label for="telefone6" class="form-label">Telefone 6</label>
            <div class="d-flex align-items-center flex-wrap gap-1">
              <input type="text" name="telefone6" id="telefone6" class="form-control 
                {% if devedor.telefone6_valido == 'SIM' %}status-valid{% elif devedor.telefone6_valido == 'NÃO' %}status-invalid{% else %}status-unknown{% endif %}" 
                value="{{ devedor.telefone6|default:'' }}">
              <button type="button" class="btn btn-success btn-sm" title="Abrir no WhatsApp"
                      data-whats="{{ devedor.telefone6|clean_phone_number }}" onclick="abrirModalWhats(this)">
                <i class="bi bi-whatsapp"></i> <span class="d-none d-sm-inline">WhatsApp</span>
              </button>
              <input type="hidden" name="telefone6_valido" id="telefone6_valido" value="{{ devedor.telefone6_valido|default:'NAO VERIFICADO' }}">
              <div class="btn-group">
                <button type="button" class="btn btn-success btn-sm {% if devedor.telefone6_valido == 'SIM' %}active{% endif %}" onclick="updateValidationStatus('telefone6', 'SIM')"><i class="fas fa-check-circle"></i></button>
                <button type="button" class="btn btn-danger btn-sm {% if devedor.telefone6_valido == 'NÃO' %}active{% endif %}" onclick="updateValidationStatus('telefone6', 'NÃO')"><i class="fas fa-times-circle"></i></button>
                <button type="button" class="btn btn-secondary btn-sm {% if devedor.telefone6_valido == 'NAO VERIFICADO' %}active{% endif %}" onclick="updateValidationStatus('telefone6', 'NAO VERIFICADO')"><i class="fas fa-question-circle"></i></button>
              </div>
            </div>
          </div>

          <!-- Telefone 7 -->
          <div class="col-12 col-md-6 telefone-group">
            <label for="telefone7" class="form-label">Telefone 7</label>
            <div class="d-flex align-items-center flex-wrap gap-1">
              <input type="text" name="telefone7" id="telefone7" class="form-control 
                {% if devedor.telefone7_valido == 'SIM' %}status-valid{% elif devedor.telefone7_valido == 'NÃO' %}status-invalid{% else %}status-unknown{% endif %}" 
                value="{{ devedor.telefone7|default:'' }}">
              <button type="button" class="btn btn-success btn-sm" title="Abrir no WhatsApp"
                      data-whats="{{ devedor.telefone7|clean_phone_number }}" onclick="abrirModalWhats(this)">
                <i class="bi bi-whatsapp"></i> <span class="d-none d-sm-inline">WhatsApp</span>
              </button>
              <input type="hidden" name="telefone7_valido" id="telefone7_valido" value="{{ devedor.telefone7_valido|default:'NAO VERIFICADO' }}">
              <div class="btn-group">
                <button type="button" class="btn btn-success btn-sm {% if devedor.telefone7_valido == 'SIM' %}active{% endif %}" onclick="updateValidationStatus('telefone7', 'SIM')"><i class="fas fa-check-circle"></i></button>
                <button type="button" class="btn btn-danger btn-sm {% if devedor.telefone7_valido == 'NÃO' %}active{% endif %}" onclick="updateValidationStatus('telefone7', 'NÃO')"><i class="fas fa-times-circle"></i></button>
                <button type="button" class="btn btn-secondary btn-sm {% if devedor.telefone7_valido == 'NAO VERIFICADO' %}active{% endif %}" onclick="updateValidationStatus('telefone7', 'NAO VERIFICADO')"><i class="fas fa-question-circle"></i></button>
              </div>
            </div>
          </div>

          <!-- Telefone 8 -->
          <div class="col-12 col-md-6 telefone-group">
            <label for="telefone8" class="form-label">Telefone 8</label>
            <div class="d-flex align-items-center flex-wrap gap-1">
              <input type="text" name="telefone8" id="telefone8" class="form-control 
                {% if devedor.telefone8_valido == 'SIM' %}status-valid{% elif devedor.telefone8_valido == 'NÃO' %}status-invalid{% else %}status-unknown{% endif %}" 
                value="{{ devedor.telefone8|default:'' }}">
              <button type="button" class="btn btn-success btn-sm" title="Abrir no WhatsApp"
                      data-whats="{{ devedor.telefone8|clean_phone_number }}" onclick="abrirModalWhats(this)">
                <i class="bi bi-whatsapp"></i> <span class="d-none d-sm-inline">WhatsApp</span>
              </button>
              <input type="hidden" name="telefone8_valido" id="telefone8_valido" value="{{ devedor.telefone8_valido|default:'NAO VERIFICADO' }}">
              <div class="btn-group">
                <button type="button" class="btn btn-success btn-sm {% if devedor.telefone8_valido == 'SIM' %}active{% endif %}" onclick="updateValidationStatus('telefone8', 'SIM')"><i class="fas fa-check-circle"></i></button>
                <button type="button" class="btn btn-danger btn-sm {% if devedor.telefone8_valido == 'NÃO' %}active{% endif %}" onclick="updateValidationStatus('telefone8', 'NÃO')"><i class="fas fa-times-circle"></i></button>
                <button type="button" class="btn btn-secondary btn-sm {% if devedor.telefone8_valido == 'NAO VERIFICADO' %}active{% endif %}" onclick="updateValidationStatus('telefone8', 'NAO VERIFICADO')"><i class="fas fa-question-circle"></i></button>
              </div>
            </div>
          </div>

          <!-- Telefone 9 -->
          <div class="col-12 col-md-6 telefone-group">
            <label for="telefone9" class="form-label">Telefone 9</label>
            <div class="d-flex align-items-center flex-wrap gap-1">
              <input type="text" name="telefone9" id="telefone9" class="form-control 
                {% if devedor.telefone9_valido == 'SIM' %}status-valid{% elif devedor.telefone9_valido == 'NÃO' %}status-invalid{% else %}status-unknown{% endif %}" 
                value="{{ devedor.telefone9|default:'' }}">
              <button type="button" class="btn btn-success btn-sm" title="Abrir no WhatsApp"
                      data-whats="{{ devedor.telefone9|clean_phone_number }}" onclick="abrirModalWhats(this)">
                <i class="bi bi-whatsapp"></i> <span class="d-none d-sm-inline">WhatsApp</span>
              </button>
              <input type="hidden" name="telefone9_valido" id="telefone9_valido" value="{{ devedor.telefone9_valido|default:'NAO VERIFICADO' }}">
              <div class="btn-group">
                <button type="button" class="btn btn-success btn-sm {% if devedor.telefone9_valido == 'SIM' %}active{% endif %}" onclick="updateValidationStatus('telefone9', 'SIM')"><i class="fas fa-check-circle"></i></button>
                <button type="button" class="btn btn-danger btn-sm {% if devedor.telefone9_valido == 'NÃO' %}active{% endif %}" onclick="updateValidationStatus('telefone9', 'NÃO')"><i class="fas fa-times-circle"></i></button>
                <button type="button" class="btn btn-secondary btn-sm {% if devedor.telefone9_valido == 'NAO VERIFICADO' %}active{% endif %}" onclick="updateValidationStatus('telefone9', 'NAO VERIFICADO')"><i class="fas fa-question-circle"></i></button>
              </div>
            </div>
          </div>

          <!-- Telefone 10 -->
          <div class="col-12 col-md-6 telefone-group">
            <label for="telefone10" class="form-label">Telefone 10</label>
            <div class="d-flex align-items-center flex-wrap gap-1">
              <input type="text" name="telefone10" id="telefone10" class="form-control 
                {% if devedor.telefone10_valido == 'SIM' %}status-valid{% elif devedor.telefone10_valido == 'NÃO' %}status-invalid{% else %}status-unknown{% endif %}" 
                value="{{ devedor.telefone10|default:'' }}">
              <button type="button" class="btn btn-success btn-sm" title="Abrir no WhatsApp"
                      data-whats="{{ devedor.telefone10|clean_phone_number }}" onclick="abrirModalWhats(this)">
                <i class="bi bi-whatsapp"></i> <span class="d-none d-sm-inline">WhatsApp</span>
              </button>
              <input type="hidden" name="telefone10_valido" id="telefone10_valido" value="{{ devedor.telefone10_valido|default:'NAO VERIFICADO' }}">
              <div class="btn-group">
                <button type="button" class="btn btn-success btn-sm {% if devedor.telefone10_valido == 'SIM' %}active{% endif %}" onclick="updateValidationStatus('telefone10', 'SIM')"><i class="fas fa-check-circle"></i></button>
                <button type="button" class="btn btn-danger btn-sm {% if devedor.telefone10_valido == 'NÃO' %}active{% endif %}" onclick="updateValidationStatus('telefone10', 'NÃO')"><i class="fas fa-times-circle"></i></button>
                <button type="button" class="btn btn-secondary btn-sm {% if devedor.telefone10_valido == 'NAO VERIFICADO' %}active{% endif %}" onclick="updateValidationStatus('telefone10', 'NAO VERIFICADO')"><i class="fas fa-question-circle"></i></button>
              </div>
            </div>
          </div>

        </div>

        <style>
          .status-valid{border-color:#28a745!important;background:#e9f9ee!important}
          .status-invalid{border-color:#dc3545!important;background:#fff5f5!important}
          .status-unknown{border-color:#6c757d!important;background:#f1f3f5!important}
          .btn-group .btn{width:40px;display:flex;align-items:center;justify-content:center}
        </style>
        <script>
          function updateValidationStatus(fieldId,status){
            const i=document.getElementById(fieldId), h=document.getElementById(fieldId+'_valido');
            i.classList.remove('status-valid','status-invalid','status-unknown');
            if(status==='SIM') i.classList.add('status-valid'); else if(status==='NÃO') i.classList.add('status-invalid'); else i.classList.add('status-unknown');
            if(h) h.value=status;
          }
        </script>

        <button type="submit" class="btn btn-primary w-100 mt-3">Salvar Alterações</button>
      </form>
    </div>
  </div>

  <!-- ===================== GERAR PROPOSTA AO CREDOR ===================== -->
  <div class="card detalhes-card">
    <div class="card-header bg-warning text-dark d-flex flex-wrap align-items-center justify-content-between gap-2">
      <h3 class="m-0">Gerar proposta ao credor</h3>
      <div class="d-flex gap-2 flex-wrap">
        <span class="badge bg-success">Desconto à vista % {{ percentual_avista_default }}</span>
        <span class="badge bg-primary">Desconto parcelado % {{ percentual_parc_default }}</span>
      </div>
    </div>
    <div class="card-body">
      <div class="proposta-grid">
        <!-- Base com juros -->
        <div>
          <label class="form-label"><strong>Base (pendente + juros)</strong></label>
          <input id="valorBase" type="text" class="form-control" readonly
                 data-total="{{ saldo_pendente|default:total_pendente|default:0|unlocalize }}"
                 data-capital="{{ total_pendente|default:''|unlocalize }}"
                 value="{{ saldo_pendente|default:total_pendente|default:0|floatformat:2 }}">
        </div>
        <div>
          <label class="form-label"><strong>Capital (sem juros)</strong></label>
          <input id="valorCapital" type="text" class="form-control" readonly value="R$ 0,00">
        </div>
        <div>
          <label class="form-label"><strong>Juros apurados</strong></label>
          <input id="valorJuros" type="text" class="form-control" readonly value="R$ 0,00">
        </div>

        <!-- Percentuais -->
        <div>
          <label class="form-label">Desconto à vista (%) <small class="text-muted d-block">apenas nos juros</small></label>
          <div class="input-group">
            <input id="pctAvista" type="number" class="form-control" value="{{ percentual_avista_default }}">
            <button type="button" class="btn btn-outline-success btn-sm" onclick="aplicarAtalho('avista')">{{ percentual_avista_default }}%</button>
          </div>
        </div>
        <div>
          <label class="form-label">Desconto parcelado (%) <small class="text-muted d-block">apenas nos juros</small></label>
          <div class="input-group">
            <input id="pctParc" type="number" class="form-control" value="{{ percentual_parc_default }}">
            <button type="button" class="btn btn-outline-primary btn-sm" onclick="aplicarAtalho('parc')">{{ percentual_parc_default }}%</button>
          </div>
        </div>

        <div>
          <label class="form-label">Entrada (%)</label>
          <input id="pctEntrada" type="number" class="form-control" value="25">
        </div>
        <div>
          <label class="form-label">Quantidade de parcelas</label>
          <input id="qtdParcelas" type="number" class="form-control" min="1" value="6">
        </div>
        <div>
          <label class="form-label">Data da entrada</label>
          <input id="dataEntrada" type="date" class="form-control" value="{{ today|date:'Y-m-d' }}">
        </div>

        <!-- Calculados -->
        <div>
          <label class="form-label">À vista <small class="text-muted d-block">(capital + juros c/ desconto)</small></label>
          <input id="valorAvista" type="text" class="form-control" readonly>
        </div>
        <div>
          <label class="form-label">Total parcelado <small class="text-muted d-block">(capital + juros c/ desconto)</small></label>
          <input id="totalProposta" type="text" class="form-control" readonly>
        </div>
        <div>
          <label class="form-label">Entrada (auto)</label>
          <input id="valorEntrada" type="text" class="form-control" readonly>
        </div>
        <div>
          <label class="form-label">Parcela (auto)</label>
          <input id="valorParcela" type="text" class="form-control" readonly>
        </div>

        <!-- Modo manual opcional -->
        <div class="col-12 form-check mt-2">
          <input class="form-check-input" type="checkbox" id="editarManual">
          <label class="form-check-label" for="editarManual">Permitir edição manual dos campos calculados</label>
        </div>

        <!-- Cronograma -->
        <div class="col-12">
          <label class="form-label mb-1"><strong>Cronograma das parcelas (auto)</strong></label>
          <div class="table-responsive-wrapper">
            <table class="table table-sm align-middle mb-0 detalhes-table" id="tabelaParcelas">
              <thead class="table-light"><tr><th>#</th><th>Vencimento</th><th>Valor</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <hr>

      <!-- PRÉVIA INTERNA (CREDOR) — APENAS COPIAR/SALVAR -->
      <label class="form-label"><strong>Prévia do texto ao CREDOR (será salvo em Detalhamento)</strong></label>
      <textarea id="previewInterno" class="form-control" rows="12" spellcheck="false"></textarea>

      <div class="d-flex gap-2 mt-3 flex-wrap">
        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="copiarTextoCredor()">
          <i class="fas fa-copy"></i> <span class="d-none d-sm-inline">Copiar texto</span>
        </button>
        <button type="button" class="btn btn-success btn-sm" onclick="abrirModalWhatsProposta()">
          <i class="bi bi-whatsapp"></i> <span class="d-none d-sm-inline">Enviar WhatsApp</span>
        </button>
        <button type="button" class="btn btn-primary btn-sm" onclick="salvarPropostaAcordo()">
          <i class="fas fa-save"></i> <span class="d-none d-sm-inline">Salvar Proposta</span>
        </button>
        <a href="{% url 'realizar_acordo' titulo.id %}" class="btn btn-success btn-sm">
          <i class="fas fa-handshake"></i> <span class="d-none d-sm-inline">Gerar Acordo</span>
        </a>
        
        <!-- Botão de Debug Temporário -->
        <!-- <button type="button" class="btn btn-warning" onclick="debugCampos()">
          <i class="fas fa-bug"></i> Debug Campos
        </button> -->
        
        <!-- Botão para testar com valores fictícios -->
        <!-- <button type="button" class="btn btn-info" onclick="testarComValoresFicticios()">
          <i class="fas fa-flask"></i> Testar Valores
        </button> -->
        
        <!-- Botão para forçar preenchimento -->
        <!-- <button type="button" class="btn btn-success" onclick="forcarPreenchimentoCampos()">
          <i class="fas fa-magic"></i> Forçar Preenchimento
        </button> -->
      </div>
      <small class="text-muted d-block mt-2">
        Observação: o texto acima é <strong>apenas para o CREDOR</strong>. Não há envio por WhatsApp desta proposta.
      </small>
    </div>
  </div>

  <style>
    .badge{font-size:.9rem}
    
    /* Garantir que os campos calculados sejam visíveis */
    #valorAvista, #totalProposta, #valorEntrada, #valorParcela {
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
    }
    
    /* Garantir que a tabela de cronograma seja visível */
    #tabelaParcelas {
      display: table !important;
      visibility: visible !important;
      opacity: 1 !important;
    }
    
    /* Garantir que o checkbox de edição manual seja visível */
    #editarManual {
      display: block !important;
      visibility: visible !important;
    }
  </style>
  <script>
    console.log('=== SCRIPT CARREGADO ===');
    
    // ===== Utils
    const moedaBRL = v => {
      const valor = Number(v||0);
      return new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(valor);
    };
    const parseBRL = s => { if(!s) return 0; s=(''+s).replace(/[^\d,.-]/g,'').replace(/\./g,'').replace(',','.'); const n=Number(s); return isNaN(n)?0:n; };
    const pad2 = n => String(n).padStart(2,'0');
    const fmtDateBR = iso => { if(!iso) return '-'; const [y,m,d]=iso.split('-'); return `${d}/${m}/${y}`; };
    const parseBRDateToISO = br => { if(!br||!/^\d{2}\/\d{2}\/\d{4}$/.test(br)) return ''; const [d,m,y]=br.split('/'); return `${y}-${m}-${d}`; };
    const addMonths = (iso, m)=>{ if(!iso) return ''; const [y,mo,d]=iso.split('-').map(Number); const dt=new Date(y,mo-1,d); dt.setMonth(dt.getMonth()+m); return `${dt.getFullYear()}-${pad2(dt.getMonth()+1)}-${pad2(dt.getDate())}`; };

    // ===== Função para forçar cálculo inicial
    function forcarCalculoInicial() {
      console.log('=== FORÇANDO CÁLCULO INICIAL ===');
      
      // Aguardar um pouco para garantir que todos os elementos estejam prontos
      setTimeout(() => {
        console.log('Executando cálculo inicial...');
        atualizarCalculos();
        
        // Verificar se os valores foram preenchidos
        const campos = ['valorAvista', 'totalProposta', 'valorEntrada', 'valorParcela'];
        campos.forEach(id => {
          const el = document.getElementById(id);
          if (el) {
            console.log(`Campo ${id} valor:`, el.value);
          }
        });
        
        // Se os campos não foram preenchidos, forçar preenchimento
        setTimeout(() => {
          forcarPreenchimentoCampos();
        }, 200);
      }, 100);
    }

    // ===== Função para forçar preenchimento dos campos
    function forcarPreenchimentoCampos() {
      console.log('=== FORÇANDO PREENCHIMENTO DOS CAMPOS ===');
      
      // Obter os valores calculados
      const { total, capital, juros } = lerTotaisEVencimentoEAtraso();
      const pctAvista = Number(document.getElementById('pctAvista')?.value || 0);
      const pctParc = Number(document.getElementById('pctParc')?.value || 0);
      const pctEntrada = Number(document.getElementById('pctEntrada')?.value || 0);
      const qtdParcelas = Math.max(1, parseInt(document.getElementById('qtdParcelas')?.value || '1', 10));
      
      // Calcular valores
      const jurosAvista = Math.max(0, juros * (1 - pctAvista/100));
      const jurosParcel = Math.max(0, juros * (1 - pctParc/100));
      
      const valorAvista = capital + jurosAvista;
      const totalProposta = capital + jurosParcel;
      const valorEntrada = totalProposta * (pctEntrada/100);
      const valorParcela = qtdParcelas > 0 ? (totalProposta - valorEntrada) / qtdParcelas : 0;
      
      console.log('Valores para forçar:', { valorAvista, totalProposta, valorEntrada, valorParcela });
      
      // Forçar preenchimento
      const campos = [
        { id: 'valorAvista', valor: valorAvista },
        { id: 'totalProposta', valor: totalProposta },
        { id: 'valorEntrada', valor: valorEntrada },
        { id: 'valorParcela', valor: valorParcela }
      ];
      
      campos.forEach(({ id, valor }) => {
        const el = document.getElementById(id);
        if (el) {
          el.value = moedaBRL(valor);
          console.log(`Campo ${id} forçado para:`, el.value);
        }
      });
    }

    // ===== Função para garantir visibilidade dos campos
    function garantirVisibilidadeCampos() {
      const campos = ['valorAvista', 'totalProposta', 'valorEntrada', 'valorParcela', 'editarManual', 'tabelaParcelas'];
      campos.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.style.display = 'block';
          el.style.visibility = 'visible';
          el.style.opacity = '1';
          console.log(`Campo ${id} forçado a ser visível`);
        }
      });
    }

    // ===== Função de debug para verificar campos
    function debugCampos() {
      console.log('=== DEBUG DOS CAMPOS ===');
      
      const campos = ['valorAvista', 'totalProposta', 'valorEntrada', 'valorParcela', 'editarManual', 'tabelaParcelas'];
      campos.forEach(id => {
        const el = document.getElementById(id);
        console.log(`\nCampo: ${id}`);
        console.log('  - Existe:', !!el);
        if (el) {
          console.log('  - Elemento:', el);
          console.log('  - Visível:', el.offsetParent !== null);
          console.log('  - Display:', window.getComputedStyle(el).display);
          console.log('  - Visibility:', window.getComputedStyle(el).visibility);
          console.log('  - Opacity:', window.getComputedStyle(el).opacity);
          console.log('  - Position:', window.getComputedStyle(el).position);
          console.log('  - Z-index:', window.getComputedStyle(el).zIndex);
          console.log('  - Parent:', el.parentElement);
          console.log('  - Rect:', el.getBoundingClientRect());
        }
      });
      
      // Forçar visibilidade
      garantirVisibilidadeCampos();
      
      // Tentar recalcular
      atualizarCalculos();
      
      alert('Debug executado! Verifique o console (F12) para detalhes.');
    }

    // ===== Função para testar com valores fictícios
    function testarComValoresFicticios() {
      console.log('=== TESTANDO COM VALORES FICTÍCIOS ===');
      
      // Simular dados de teste
      const valorBaseEl = document.getElementById('valorBase');
      if (valorBaseEl) {
        valorBaseEl.dataset.total = '1000';
        valorBaseEl.dataset.capital = '800';
        valorBaseEl.value = 'R$ 1.000,00';
        console.log('Valores fictícios aplicados ao valorBase');
      }
      
      const valorCapitalEl = document.getElementById('valorCapital');
      if (valorCapitalEl) {
        valorCapitalEl.value = 'R$ 800,00';
      }
      
      const valorJurosEl = document.getElementById('valorJuros');
      if (valorJurosEl) {
        valorJurosEl.value = 'R$ 200,00';
      }
      
      // Tentar recalcular
      atualizarCalculos();
      
      alert('Valores fictícios aplicados! Verifique se os cálculos funcionaram.');
    }

    // ===== Extrai títulos das tabelas (entrada + associados)
    function extrairTitulos(){
      try {
        const arr=[];
        const te = document.getElementById('tblTitulosEntrada');
        console.log('Tabela entrada encontrada:', !!te);
        
        if(te){
          te.querySelectorAll('tbody tr').forEach(tr=>{
            const td=tr.querySelectorAll('td'); 
            if(td.length<12) return;
            const capital = parseBRL(td[3].textContent);            // Valor Divida
            const vencBR  = (td[7].textContent||'').trim();         // Vencimento
            const juros   = parseBRL(td[9].textContent);            // Juros
            const comJuros= parseBRL(td[10].textContent);           // Valor com juros
            const dias    = parseInt((td[11].textContent||'0').replace(/\D/g,''))||0; // Dias atraso
            const iso     = parseBRDateToISO(vencBR);
            const total   = comJuros || (capital + juros);
            const ju      = (juros || Math.max(0,total-capital));
            if(capital>0 || total>0){ arr.push({capital, juros: ju, total, iso, dias}); }
          });
        }
        
        const ta = document.getElementById('tblTitulosAssociados');
        console.log('Tabela associados encontrada:', !!ta);
        
        if(ta){
          ta.querySelectorAll('tbody tr').forEach(tr=>{
            const td=tr.querySelectorAll('td'); 
            if(td.length<12) return;
            const total   = parseBRL(td[4].textContent);            // Total & Parcela
            const vencBR  = (td[6].textContent||'').trim();
            const juros   = parseBRL(td[8].textContent);
            const cap     = Math.max(0, total - juros);
            const dias    = parseInt((td[9].textContent||'0').replace(/\D/g,''))||0;
            const iso     = parseBRDateToISO(vencBR);
            if(cap>0 || total>0){ arr.push({capital: cap, juros, total, iso, dias}); }
          });
        }
        
        let sumCap=0, sumJuros=0, sumTotal=0, firstISO='', maxDias=0;
        arr.forEach(x=>{
          sumCap+=x.capital||0; 
          sumJuros+=x.juros||0; 
          sumTotal+=x.total||0;
          if(x.iso){ if(!firstISO || new Date(x.iso) < new Date(firstISO)) firstISO = x.iso; }
          if(x.dias && x.dias>maxDias) maxDias=x.dias;
        });
        
        console.log('Títulos extraídos:', arr.length, 'somas:', { sumCap, sumJuros, sumTotal, firstISO, maxDias });
        
        return { sumCap, sumJuros, sumTotal, firstISO, maxDias };
      } catch (error) {
        console.error('Erro em extrairTitulos:', error);
        return { sumCap: 0, sumJuros: 0, sumTotal: 0, firstISO: '', maxDias: 0 };
      }
    }

    // ===== Lê totais + fallback
    function lerTotaisEVencimentoEAtraso(){
      try {
        console.log('=== INICIANDO lerTotaisEVencimentoEAtraso ===');
        
        const el = document.getElementById('valorBase');
        console.log('Elemento valorBase encontrado:', !!el);
        
        if (el) {
          console.log('Dataset do valorBase:', el.dataset);
          console.log('Valor atual do campo:', el.value);
        }
        
        const totalContext = Number(el?.dataset.total || 0);
        const capitalContext = el?.dataset.capital !== '' ? Number(el.dataset.capital) : NaN;

        console.log('Dados do elemento valorBase:', { 
          totalContext, 
          capitalContext, 
          dataset: el?.dataset 
        });

        const viaTabela = extrairTitulos();
        console.log('Dados extraídos da tabela:', viaTabela);

        const total = viaTabela.sumTotal || totalContext || 0;

        let capital = viaTabela.sumCap || (!isNaN(capitalContext) ? capitalContext : 0);
        let juros   = viaTabela.sumJuros || Math.max(0, total - capital);

        const firstISO = viaTabela.firstISO || '';
        const maxDias  = viaTabela.maxDias || 0;

        console.log('Valores finais:', { total, capital, juros, firstISO, maxDias });

        // Reflete nos campos visuais
        const valorBaseEl = document.getElementById('valorBase');
        const valorCapitalEl = document.getElementById('valorCapital');
        const valorJurosEl = document.getElementById('valorJuros');

        if (valorBaseEl) valorBaseEl.value = moedaBRL(total||0);
        if (valorCapitalEl) valorCapitalEl.value = moedaBRL(capital||0);
        if (valorJurosEl) valorJurosEl.value = moedaBRL(juros||0);

        return { total, capital, juros, firstISO, maxDias };
      } catch (error) {
        console.error('Erro em lerTotaisEVencimentoEAtraso:', error);
        return { total: 0, capital: 0, juros: 0, firstISO: '', maxDias: 0 };
      }
    }

    let modoManual=false;
    function toggleEdicaoManual(recalcular = true){
      modoManual=document.getElementById('editarManual').checked;
      ['valorAvista','totalProposta','valorEntrada','valorParcela'].forEach(id=>{
        const el=document.getElementById(id); if(el) el.readOnly=!modoManual;
      });
      
      // Só recalcula se solicitado explicitamente
      if(recalcular) {
        atualizarCalculos();
      }
    }
    function sincronizarHidden(){
      const t=document.getElementById('previewInterno').value||''; 
      const h=document.getElementById('textoHidden'); if(h) h.value=t;
    }
    async function copiarTextoCredor(){
      const t=document.getElementById('previewInterno')?.value||'';
      try{
        await navigator.clipboard.writeText(t);
        alert('Texto copiado para a área de transferência.');
      }catch(e){
        // fallback
        const ta=document.createElement('textarea'); ta.value=t; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
        alert('Texto copiado.');
      }
    }

    function montarTabelaParcelas(qtdParcelas, dataEntrada, valorParcela){
      try {
        const tbody=document.querySelector('#tabelaParcelas tbody'); 
        if(!tbody) {
          console.error('Tabela de parcelas não encontrada');
          return;
        }
        
        const baseISO=dataEntrada || new Date().toISOString().slice(0,10);
        let html='';
        
        console.log('Montando tabela:', { qtdParcelas, dataEntrada, valorParcela, baseISO });
        
        for(let i=1;i<=qtdParcelas;i++){
          const iso=addMonths(baseISO,i);
          html += `<tr><td>${i}</td><td>${fmtDateBR(iso)}</td><td>${moedaBRL(valorParcela)}</td></tr>`;
        }
        tbody.innerHTML=html;
        
        console.log('Tabela montada com', qtdParcelas, 'parcelas');
      } catch (error) {
        console.error('Erro em montarTabelaParcelas:', error);
      }
    }

    // ===== Texto (Credor)
    function montarTextoInterno(ctx, tot, cap, jur, pctAvista, pctParc, valorAvista, totalProposta, dataEntrada, valorEntrada, qtdParcelas, valorParcela, primeiroVenc, maxAtraso){
      const baseISO=dataEntrada || new Date().toISOString().slice(0,10);
      const unesc = s => (s || '').replace(/\\u([0-9a-fA-F]{4})/g,(_,h)=>String.fromCharCode(parseInt(h,16))).replace(/&amp;/g,'&');
      const linhas=[];
      for(let i=1;i<=qtdParcelas;i++){ const iso=addMonths(baseISO,i); linhas.push(`Parcela ${i}: ${moedaBRL(valorParcela)} (venc. ${fmtDateBR(iso)})`); }
      return [
        "Apresentamos a seguinte proposta de pagamento:",
        `Devedor: ${unesc(ctx.devedor) || '-'}`,
        `Empresa: ${unesc(ctx.fantasia||ctx.razao) || '-'}`,
        "",
        `→ Total à vista: ${moedaBRL(valorAvista)}`,
        "",
        `→ Total parcelado: ${moedaBRL(totalProposta)}`,
        `Entrada em ${dataEntrada?fmtDateBR(dataEntrada):'-'}: ${moedaBRL(valorEntrada)}`,
        `Parcelas: ${qtdParcelas}x de ${moedaBRL(valorParcela)}`,
        "",
        "Cronograma:",
        ...linhas,
        "",
        "ATENÇÃO",
        "",
        `Todo e qualquer pagamento deverá ser feito diretamente ao lojista, de preferência presencialmente ou por meio da chave pix do mesmo ${ctx.pix || 'chave pix'}`,
        "",
        "Ficamos no aguardo do envio do comprovante de pagamento para podermos registrar ao acordo e validar o mesmo.",
        "",
        "Atenciosamente,",
        (ctx.user||'').toString(),
        "Atendimento ao Cliente",
        "Negociar Cobranças"
      ].join("\n");
    }

    function atualizarCalculos(){
      try {
        console.log('=== INICIANDO atualizarCalculos ===');
        
        const ctxEl=document.getElementById('ctx');
        if (!ctxEl) {
          console.error('Elemento ctx não encontrado');
          return;
        }
        
        const ctx={
          user: ctxEl.dataset.user||'',
          devedor: ctxEl.dataset.devedor||'',
          fantasia: ctxEl.dataset.empresaFantasia||'',
          razao: ctxEl.dataset.empresaRazao||'',
          empresa: (ctxEl.dataset.empresaFantasia||ctxEl.dataset.empresaRazao||''),
          pix: ctxEl.dataset.chavePix||''
        };

        const { total, capital, juros, firstISO, maxDias } = lerTotaisEVencimentoEAtraso();
        
        console.log('Valores calculados:', { total, capital, juros, firstISO, maxDias });

        const pctAvista  = Number(document.getElementById('pctAvista')?.value || 0);
        const pctParc    = Number(document.getElementById('pctParc')?.value || 0);
        const pctEntrada = Number(document.getElementById('pctEntrada')?.value || 0);
        const qtdParcelas= Math.max(1, parseInt(document.getElementById('qtdParcelas')?.value || '1', 10));
        const dataEntrada= document.getElementById('dataEntrada')?.value || '';

        console.log('Parâmetros:', { pctAvista, pctParc, pctEntrada, qtdParcelas, dataEntrada });

        // DESCONTO SÓ NOS JUROS
        const jurosAvista = Math.max(0, juros * (1 - pctAvista/100));
        const jurosParcel = Math.max(0, juros * (1 - pctParc/100));

        let valorAvista, totalProposta, valorEntrada, valorParcela;
        if(modoManual){
          valorAvista   = parseBRL(document.getElementById('valorAvista')?.value || '0');
          totalProposta = parseBRL(document.getElementById('totalProposta')?.value || '0');
          valorEntrada  = parseBRL(document.getElementById('valorEntrada')?.value || '0');
          valorParcela  = parseBRL(document.getElementById('valorParcela')?.value || '0');
        }else{
          valorAvista   = capital + jurosAvista;
          totalProposta = capital + jurosParcel;
          valorEntrada  = totalProposta * (pctEntrada/100);
          valorParcela  = qtdParcelas > 0 ? (totalProposta - valorEntrada) / qtdParcelas : 0;

          console.log('Valores calculados:', { valorAvista, totalProposta, valorEntrada, valorParcela });

          // Atualizar campos apenas se existirem
          const valorAvistaEl = document.getElementById('valorAvista');
          const totalPropostaEl = document.getElementById('totalProposta');
          const valorEntradaEl = document.getElementById('valorEntrada');
          const valorParcelaEl = document.getElementById('valorParcela');

          console.log('Elementos encontrados:', {
            valorAvista: !!valorAvistaEl,
            totalProposta: !!totalPropostaEl,
            valorEntrada: !!valorEntradaEl,
            valorParcela: !!valorParcelaEl
          });

          if (valorAvistaEl) {
            valorAvistaEl.value = moedaBRL(valorAvista);
            console.log('valorAvista atualizado para:', valorAvistaEl.value);
          }
          if (totalPropostaEl) {
            totalPropostaEl.value = moedaBRL(totalProposta);
            console.log('totalProposta atualizado para:', totalPropostaEl.value);
          }
          if (valorEntradaEl) {
            valorEntradaEl.value = moedaBRL(valorEntrada);
            console.log('valorEntrada atualizado para:', valorEntradaEl.value);
          }
          if (valorParcelaEl) {
            valorParcelaEl.value = moedaBRL(valorParcela);
            console.log('valorParcela atualizado para:', valorParcelaEl.value);
          }
        }

        montarTabelaParcelas(qtdParcelas, dataEntrada, valorParcela);

        // texto interno (CREDOR) → salvo/copiar
        const previewEl = document.getElementById('previewInterno');
        if (previewEl) {
          previewEl.value = montarTextoInterno(ctx, total, capital, juros,
                             pctAvista, pctParc,
                             valorAvista, totalProposta,
                             dataEntrada, valorEntrada, qtdParcelas, valorParcela,
                             firstISO, maxDias);
        }

        sincronizarHidden();
      } catch (error) {
        console.error('Erro em atualizarCalculos:', error);
      }
    }

    function aplicarAtalho(tipo){
      if (tipo === 'avista') document.getElementById('pctAvista').value = '{{ percentual_avista_default }}';
      else document.getElementById('pctParc').value = '{{ percentual_parc_default }}';
      atualizarCalculos();
    }

    document.getElementById('editarManual').addEventListener('change', ()=>{ toggleEdicaoManual(true); });
    ['pctAvista','pctParc','pctEntrada','qtdParcelas','dataEntrada'].forEach(id=>{
      const el = document.getElementById(id);
      if (el) {
        el.addEventListener('input', atualizarCalculos);
      }
    });
    ['valorAvista','totalProposta','valorEntrada','valorParcela'].forEach(id=>{
      const el = document.getElementById(id);
      if (el) {
        el.addEventListener('input', ()=>{ if(modoManual) atualizarCalculos(); });
      }
    });
    
    const previewEl = document.getElementById('previewInterno');
    if (previewEl) {
      previewEl.addEventListener('input', sincronizarHidden);
    }
    
    const formEl = document.getElementById('formSalvarDetalhamento');
    if (formEl) {
      formEl.addEventListener('submit', sincronizarHidden);
    }

    document.addEventListener('DOMContentLoaded', ()=>{ 
      console.log('DOM carregado, inicializando cálculos...');
      
      // Garantir que os campos sejam visíveis
      garantirVisibilidadeCampos();
      
      // Verificar se os campos existem
      const campos = ['valorAvista', 'totalProposta', 'valorEntrada', 'valorParcela', 'editarManual', 'tabelaParcelas'];
      campos.forEach(id => {
        const el = document.getElementById(id);
        console.log(`Campo ${id}:`, el ? 'EXISTE' : 'NÃO EXISTE', el);
        if (el) {
          console.log(`  - Visível:`, el.offsetParent !== null);
          console.log(`  - Display:`, window.getComputedStyle(el).display);
          console.log(`  - Visibility:`, window.getComputedStyle(el).visibility);
        }
      });
      
      // PRIMEIRO: Calcular os valores automaticamente
      forcarCalculoInicial(); 
      
      // SEGUNDO: Configurar o modo manual (mas sem recalcular)
      toggleEdicaoManual(false); 
      
      // Força recálculo após um pequeno delay para garantir que todos os elementos estejam prontos
      setTimeout(() => {
        console.log('Recalculando após delay...');
        garantirVisibilidadeCampos(); // Garantir visibilidade novamente
        atualizarCalculos(); // Recalcular novamente
        
        // Verificar novamente após o delay
        campos.forEach(id => {
          const el = document.getElementById(id);
          if (el) {
            console.log(`Campo ${id} após delay:`, 'EXISTE', 'Visível:', el.offsetParent !== null);
          }
        });
      }, 500);
      
      // Recálculo adicional após mais tempo para garantir que tudo esteja pronto
      setTimeout(() => {
        console.log('Recálculo final...');
        atualizarCalculos();
      }, 1000);
    });
  </script>
  <!-- =================== FIM GERAR PROPOSTA AO CREDOR =================== -->

  <!-- =================== TÍTULOS =================== -->
  <h2 class="text-center mt-4">Títulos Associados</h2>

  {% if titulos_entrada %}
  <h2 class="text-center mt-4 mb-3" style="font-size: 1.1rem;">Entrada</h2>
  <div class="table-responsive-wrapper">
    <table id="tblTitulosEntrada" class="table table-striped table-bordered text-center detalhes-table">
    <thead class="table-dark text-center">
      <tr>
        <th>Empresa</th>
        <th>Devedor</th>
        <th>Título</th>
        <th>Valor Divida</th>
        <th>Valor Recebido</th>
        <th>Forma Pagamento</th>
        <th>Data baixa</th>
        <th>Vencimento</th>
        <th>Status</th>
        <th>Juros</th>
        <th>Valor com juros</th>
        <th>Dias Atraso</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody>
      {% for titulo in titulos_entrada %}
      <tr>
        <td>{{ titulo.empresa.razao_social|default:"N/A" }}</td>
        <td>{{ devedor.nome }}</td>
        <td>{{ titulo.num_titulo }}</td>
        <td>R$ {{ titulo.valor|floatformat:2 }}</td>
        <td>R$ {{ titulo.valorRecebido|floatformat:2 }}</td>
        <td>{{ forma_pagamento_map|get_dict_value:titulo.forma_pag_Id }}</td>
        <td>{{ titulo.data_baixa|date:"d/m/Y" }}</td>
        <td>{{ titulo.dataVencimento|date:"d/m/Y" }}</td>
        <td>
          {% if titulo.statusBaixa == 0 %}<span class="badge bg-warning text-dark">Pendente</span>
          {% elif titulo.statusBaixa == 2 %}<span class="badge bg-success">Quitado</span>
          {% elif titulo.statusBaixa == 3 %}<span class="badge bg-info text-dark">Negociado</span>{% endif %}
        </td>
        <td>R$ {{ titulo.juros|floatformat:2 }}</td>
        <td>R$ {{ titulo.valor_com_juros|floatformat:2 }}</td>
        <td>{{ titulo.dias_atraso }}</td>
        <td>
           {% if titulo.statusBaixa == 0 or titulo.statusBaixa is None %}
            <a href="{% url 'realizar_acordo' titulo.id %}" class="btn btn-sm btn-success">
              <i class="fas fa-handshake"></i> Gerar Acordo
            </a>
            <a href="{% url 'realizar_baixa' titulo.id %}" class="btn btn-sm btn-primary">
              <i class="fas fa-download"></i> Baixar
            </a>
            <a href="{% url 'editar_titulo' titulo.id %}" class="btn btn-warning">Editar</a>
          {% endif %}
          {% if titulo.statusBaixa == 3 %}
            <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#modalQuitar{{ titulo.id }}">
              <i class="fas fa-check"></i> Quitar
            </button>
            <a href="{% url 'editar_titulo' titulo.id %}" class="btn btn-warning">Editar</a>
            <a href="{% url 'reparcelar_acordo' titulo.id %}" class="btn btn-outline-secondary btn-sm">
              <i class="fas fa-redo"></i> Reparcelar acordo
            </a>
          {% endif %}
          {% if titulo.statusBaixa == 2 %}
            <a href="{% url 'gerar_recibo' titulo.id %}" target="_blank" class="btn btn-sm btn-info">
              <i class="fas fa-file-pdf"></i> Gerar Recibo
            </a>
            <button type="button" class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#modalExtornar{{ titulo.id }}">
              <i class="fas fa-undo"></i> Extornar
            </button>
          {% endif %}
        </td>
      </tr>

      <!-- Modal Quitar Entrada -->
     <!-- Modal Quitar Entrada -->
<div class="modal fade" id="modalQuitar{{ titulo.id }}" tabindex="-1" aria-labelledby="modalQuitarLabel{{ titulo.id }}" aria-hidden="true">
  <div class="modal-dialog"><div class="modal-content">
    <form method="POST" action="{% url 'quitar_parcela' titulo.id %}" enctype="multipart/form-data">
      {% csrf_token %}
      <div class="modal-header">
        <h5 class="modal-title" id="modalQuitarLabel{{ titulo.id }}">Quitar Entrada</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p><strong>Título:</strong> {{ titulo.num_titulo }}</p>

        {# Usa valorRecebido se houver, senão cai para valor #}
        <p><strong>Valor a Quitar:</strong>
          R$ {{ titulo.valorRecebido|default:titulo.valor|floatformat:2 }}
        </p>

        {# Campo correto é dataVencimento #}
        <p><strong>Vencimento:</strong>
          {{ titulo.dataVencimento|date:"d/m/Y" }}
        </p>

        {# Mostra pelo FK ou pela variável de contexto (ambas funcionam) #}
        <p><strong>Devedor:</strong>
          {{ titulo.devedor.nome|default:devedor.nome }}
        </p>

        <div class="mb-3">
          <label for="valorRecebido{{ titulo.id }}" class="form-label">Valor Recebido:</label>
          <input type="number" step="0.01" class="form-control"
                 id="valorRecebido{{ titulo.id }}" name="valorRecebido"
                 value="{{ titulo.valorRecebido|default:titulo.valor|floatformat:2 }}" required>
        </div>

        <div class="mb-3">
          <label for="dataBaixa{{ titulo.id }}" class="form-label">Data de Baixa:</label>
          <input type="date" class="form-control" id="dataBaixa{{ titulo.id }}" name="dataBaixa" required>
        </div>

        <div class="mb-3">
          <label for="formaPagamento{{ titulo.id }}" class="form-label">Forma de Pagamento:</label>
          <select class="form-select" id="formaPagamento{{ titulo.id }}" name="formaPagamento" required>
            <option value="0">Pix</option>
            <option value="1">Dinheiro</option>
            <option value="2">Cartão de Débito</option>
            <option value="3">Cartão de Crédito</option>
            <option value="4">Cheque</option>
            <option value="5">Depósito em Conta</option>
            <option value="6">Pagamento na Loja</option>
            <option value="7">Boleto Bancário</option>
            <option value="8">Duplicata</option>
            <option value="9">Recebimento pelo credor</option>
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label">Comprovante (PDF ou imagem)</label>
          <input type="file" class="form-control" name="comprovante" accept="application/pdf,image/*">
          <div class="form-text">Opcional. Máx. 10MB.</div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="submit" class="btn btn-primary">Confirmar Quitação</button>
      </div>
    </form>
  </div></div>
</div>


      {% endfor %}
    </tbody>
  </table>
  </div>
  {% endif %}

  <h2 class="text-center mt-4 mb-3" style="font-size: 1.1rem;">Títulos Associados</h2>
  <div class="table-responsive-wrapper">
    <table id="tblTitulosAssociados" class="table table-striped table-bordered text-center detalhes-table">
    <thead class="table-dark text-center">
      <tr>
        <th>Empresa</th>
        <th>Devedor</th>
        <th>Título</th>
        <th>Valor Recebido</th>
        <th>Total & Parcela</th>
        <th>Forma de Pagamento</th>
        <th>Vencimento</th>
        <th>Data de Baixa</th>
        <th>Operador baixa</th>
        <th>Juros</th>
        <th>Dias de atraso</th>
        <th>Status</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody>
      {% if titulos_associados %}
        {% for titulo in titulos_associados %}
        <tr style="{% if titulo.statusBaixa == 3 and titulo.dataVencimento < today %}background-color:#FFA500;color:#000;{% endif %}">
          <td>{{ titulo.empresa.razao_social|default:"N/A" }}</td>
          <td>{{ devedor.nome }}</td>
          <td>{{ titulo.num_titulo }}</td>
          <td>R$ {{ titulo.valorRecebido|floatformat:2 }}</td>
          <td>R$ {{ titulo.valor|floatformat:2 }}</td>
          <td>{{ forma_pagamento_map|get_dict_value:titulo.forma_pag_Id }}</td>
          <td>{{ titulo.dataVencimento|date:"d/m/Y" }}</td>
          <td>{% if titulo.data_baixa %}{{ titulo.data_baixa|date:"d/m/Y" }}{% else %}-{% endif %}</td>
          <td>{{ titulo.operador|default:'-' }}</td>
          <td>R$ {{ titulo.juros|floatformat:2 }}</td>
          <td>{{ titulo.dias_atraso }}</td>
          <td>
            {% if titulo.statusBaixa == 0 or titulo.statusBaixa == None %}
              <span class="badge bg-warning text-dark">Pendente</span>
            {% elif titulo.statusBaixa == 2 %}
              <span class="badge bg-success">Quitado</span>
            {% elif titulo.statusBaixa == 3 %}
              <span class="badge bg-info text-dark">Negociado</span>
            {% endif %}
          </td>
          <td>
            {% if titulo.statusBaixa == 3 %}
              <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#modalQuitarAssoc{{ titulo.id }}">
                <i class="fas fa-check"></i> Quitar
              </button>
              <a href="{% url 'editar_titulo' titulo.id %}" class="btn btn-warning">Editar</a>
            {% endif %}
            {% if titulo.statusBaixa == 2 %}
              <a href="{% url 'gerar_recibo' titulo.id %}" target="_blank" class="btn btn-sm btn-info">
                <i class="fas fa-file-pdf"></i> Gerar Recibo
              </a>
              <button type="button" class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#modalExtornarAssoc{{ titulo.id }}">
                <i class="fas fa-undo"></i> Extornar
              </button>
            {% endif %}
            {% if titulo.statusBaixa == 0 or titulo.statusBaixa is none %}
              <a href="{% url 'realizar_acordo' titulo.id %}" class="btn btn-sm btn-success">
                <i class="fas fa-handshake"></i> Gerar Acordo
              </a>
              <a href="{% url 'realizar_baixa' titulo.id %}" class="btn btn-sm btn-primary">
                <i class="fas fa-download"></i> Baixar
              </a>
              <a href="{% url 'editar_titulo' titulo.id %}" class="btn btn-warning">Editar</a>
            {% endif %}
          </td>
        </tr>

        <!-- Modal Quitar Parcela (Associados) -->
<div class="modal fade" id="modalQuitarAssoc{{ titulo.id }}" tabindex="-1" aria-labelledby="modalQuitarAssocLabel{{ titulo.id }}" aria-hidden="true">
  <div class="modal-dialog"><div class="modal-content">
    <form method="POST" action="{% url 'quitar_parcela' titulo.id %}" enctype="multipart/form-data"
          onsubmit="return validarValorRecebido({{ titulo.id }}, {{ titulo.valor|floatformat:2|safe }});">
      {% csrf_token %}
      <div class="modal-header">
        <h5 class="modal-title" id="modalQuitarAssocLabel{{ titulo.id }}">Quitar Parcela</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p><strong>Título:</strong> {{ titulo.num_titulo }}</p>
        <p><strong>Valor a Quitar:</strong> R$ {{ titulo.valor|floatformat:2 }}</p>
        <p><strong>Vencimento:</strong> {{ titulo.dataVencimento|date:"d/m/Y" }}</p>
        <p><strong>Devedor:</strong> {{ titulo.devedor.nome|default:devedor.nome }}</p>

        <div class="mb-3">
          <label for="valorRecebido{{ titulo.id }}" class="form-label">Valor Recebido:</label>
          <input type="number" step="0.01" class="form-control" id="valorRecebido{{ titulo.id }}"
                 name="valorRecebido" value="{{ titulo.valor|floatformat:2 }}" required>
          <div id="erroValorRecebido{{ titulo.id }}" class="text-danger mt-2" style="display:none;">
            O valor recebido não pode ser menor que o valor total do título.
          </div>
        </div>

        <div class="mb-3">
          <label for="dataBaixa{{ titulo.id }}" class="form-label">Data de Baixa:</label>
          <input type="date" class="form-control" id="dataBaixa{{ titulo.id }}" name="dataBaixa" required>
        </div>

        <div class="mb-3">
          <label for="operador{{ titulo.id }}" class="form-label">Operador:</label>
          <select class="form-select" id="operador{{ titulo.id }}" name="operador" required>
            <option value="{{ request.user.username }}">{{ request.user.get_full_name|default:request.user.first_name|default:request.user.username }}</option>
            {% for user in operadores %}
              {% if user.username != request.user.username %}
                <option value="{{ user.username }}">{{ user.get_full_name|default:user.first_name|default:user.username }}</option>
              {% endif %}
            {% endfor %}
          </select>
        </div>

        <div class="mb-3">
          <label for="formaPagamento{{ titulo.id }}" class="form-label">Forma de Pagamento:</label>
          <select class="form-select" id="formaPagamento{{ titulo.id }}" name="formaPagamento" required>
            <option value="0">Pix</option>
            <option value="1">Dinheiro</option>
            <option value="2">Cartão de Débito</option>
            <option value="3">Cartão de Crédito</option>
            <option value="4">Cheque</option>
            <option value="5">Depósito em Conta</option>
            <option value="6">Pagamento na Loja</option>
            <option value="7">Boleto Bancário</option>
            <option value="8">Duplicata</option>
            <option value="9">Recebimento pelo credor</option>
            <option value="10">Óbito confirmado</option>
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label">Comprovante (PDF ou imagem)</label>
          <input type="file" class="form-control" name="comprovante" accept="application/pdf,image/*">
          <div class="form-text">Opcional. Máx. 10MB.</div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="submit" class="btn btn-primary">Confirmar Quitação</button>
      </div>
    </form>
  </div></div>
</div>

        {% endfor %}
      {% else %}
      <tr><td colspan="12">Nenhum título encontrado para esta empresa.</td></tr>
      {% endif %}
    </tbody>
  </table>
  </div>

  <!-- Modais de Extorno -->
  {% for titulo in titulos_entrada %}
    {% if titulo.statusBaixa == 2 %}
    <!-- Modal Extornar Entrada -->
    <div class="modal fade" id="modalExtornar{{ titulo.id }}" tabindex="-1" aria-labelledby="modalExtornarLabel{{ titulo.id }}" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <form method="POST" action="{% url 'extornar_parcela' titulo.id %}">
            {% csrf_token %}
            <div class="modal-header">
              <h5 class="modal-title" id="modalExtornarLabel{{ titulo.id }}">Extornar Parcela</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle"></i>
                <strong>Atenção!</strong> Esta ação irá extornar a parcela e voltar o status para "em aberto".
              </div>
              <p><strong>Título:</strong> {{ titulo.num_titulo }}</p>
              <p><strong>Devedor:</strong> {{ titulo.devedor.nome|default:devedor.nome }}</p>
              <p><strong>Valor:</strong> R$ {{ titulo.valor|floatformat:2 }}</p>
              <p><strong>Status atual:</strong> <span class="badge bg-success">Quitado</span></p>
              <p><strong>Status após extorno:</strong> <span class="badge bg-warning text-dark">Em aberto</span></p>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
              <button type="submit" class="btn btn-warning">
                <i class="fas fa-undo"></i> Confirmar Extorno
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
    {% endif %}
  {% endfor %}

  {% for titulo in titulos_associados %}
    {% if titulo.statusBaixa == 2 %}
    <!-- Modal Extornar Associado -->
    <div class="modal fade" id="modalExtornarAssoc{{ titulo.id }}" tabindex="-1" aria-labelledby="modalExtornarAssocLabel{{ titulo.id }}" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <form method="POST" action="{% url 'extornar_parcela' titulo.id %}">
            {% csrf_token %}
            <div class="modal-header">
              <h5 class="modal-title" id="modalExtornarAssocLabel{{ titulo.id }}">Extornar Parcela</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle"></i>
                <strong>Atenção!</strong> Esta ação irá extornar a parcela e voltar o status para "em aberto".
              </div>
              <p><strong>Título:</strong> {{ titulo.num_titulo }}</p>
              <p><strong>Devedor:</strong> {{ titulo.devedor.nome|default:devedor.nome }}</p>
              <p><strong>Valor:</strong> R$ {{ titulo.valor|floatformat:2 }}</p>
              <p><strong>Status atual:</strong> <span class="badge bg-success">Quitado</span></p>
              <p><strong>Status após extorno:</strong> <span class="badge bg-warning text-dark">Em aberto</span></p>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
              <button type="submit" class="btn btn-warning">
                <i class="fas fa-undo"></i> Confirmar Extorno
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
    {% endif %}
  {% endfor %}

  <script>
    function validarValorRecebido(tituloId, valorMinimo) {
      const inputValorRecebido = document.getElementById(`valorRecebido${tituloId}`);
      const erroValorRecebido = document.getElementById(`erroValorRecebido${tituloId}`);
      if (parseFloat(inputValorRecebido.value) < valorMinimo) {
        erroValorRecebido.style.display = 'block'; return false;
      }
      erroValorRecebido.style.display = 'none'; return true;
    }
  </script>

  <!-- ========== EMPRESA CREDORA ========== -->
  <div class="card detalhes-card">
    <div class="card-header bg-warning text-dark"><h3>Empresa Credora</h3></div>
    <div class="card-body">
      <div class="row g-2">
        <div class="col-12 col-md-6"><label class="form-label"><strong>Razão Social:</strong></label><p class="form-control-plaintext mb-0">{{ empresa.razao_social }}</p></div>
        <div class="col-12 col-md-6"><label class="form-label"><strong>Nome Fantasia:</strong></label><p class="form-control-plaintext mb-0">{{ empresa.nome_fantasia }}</p></div>
        <div class="col-12 col-md-6"><label class="form-label"><strong>CNPJ:</strong></label><p class="form-control-plaintext mb-0">{{ empresa.cnpj }}</p></div>
        <div class="col-12 col-md-6"><label class="form-label"><strong>Telefone:</strong></label><p class="form-control-plaintext mb-0">{{ empresa.telefone }}</p></div>
        <div class="col-12 col-md-6"><label class="form-label"><strong>E-mail:</strong></label><p class="form-control-plaintext mb-0">{{ empresa.email }}</p></div>
        <div class="col-12 col-md-6"><label class="form-label"><strong>Endereço:</strong></label><p class="form-control-plaintext mb-0">{{ empresa.endereco }}, {{ empresa.numero }}</p></div>
        <div class="col-12 col-md-6"><label class="form-label"><strong>Bairro:</strong></label><p class="form-control-plaintext mb-0">{{ empresa.bairro }}</p></div>
        <div class="col-12 col-md-6"><label class="form-label"><strong>UF:</strong></label><p class="form-control-plaintext mb-0">{{ empresa.uf }}</p></div>
        <div class="col-12 col-md-6"><label class="form-label"><strong>Cidade:</strong></label><p class="form-control-plaintext mb-0">{{ empresa.cidade }}</p></div>
        <div class="col-12 col-md-6"><label class="form-label"><strong>Chave pix:</strong></label><p class="form-control-plaintext mb-0">{{ empresa.banco }}</p></div>
      </div>
    </div>
  </div>

  <!-- ========== AGENDAMENTOS ========== -->
  <div class="card detalhes-card">
    <div class="card-header bg-success text-white d-flex flex-wrap justify-content-between align-items-center gap-2">
      <h3 class="mb-0">Agendamentos</h3>
      <a href="{% url 'criar_agendamento' %}?devedor_id={{ devedor.id }}" class="btn btn-primary btn-sm">Criar Novo Agendamento</a>
    </div>
    <div class="card-body">
      <div class="table-responsive-wrapper">
        <table class="table table-striped detalhes-table">
        <thead>
          <tr>
            <th>Data de Abertura</th>
            <th>Data de Retorno</th>
            <th>Assunto</th>
            <th>Operador</th>
            <th>Status</th>
            <th>Telefone</th>
          </tr>
        </thead>
        <tbody>
          {% for agendamento in agendamentos %}
          <tr>
            <td>{{ agendamento.data_abertura|date:"d/m/Y H:i" }}</td>
            <td>{{ agendamento.data_retorno|date:"d/m/Y H:i" }}</td>
            <td>{{ agendamento.assunto }}</td>
            <td>{{ agendamento.operador|default:"-" }}</td>

            <td>{{ agendamento.get_status_display }}</td>
            <td>
              {{ agendamento.telefone }}
              <button type="button" class="btn btn-success btn-sm ms-2" title="Abrir no WhatsApp"
                      data-whats="{{ agendamento.telefone|clean_phone_number }}" onclick="abrirModalWhats(this)">
                <i class="bi bi-whatsapp"></i> WhatsApp
              </button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      </div>
    </div>
  </div>

  <!-- ========== DETALHAMENTO ========== -->
  <div class="card detalhes-card">
  <div class="card-header bg-secondary text-white"><h3>Detalhamento</h3></div>
  <div class="card-body">
    <form method="post" action="{% url 'adicionar_follow_up' devedor.id %}" id="formDetalhamento">
      {% csrf_token %}
      <div class="mb-3">
        <label for="texto" class="form-label"><strong>Novo Detalhamento:</strong></label>
        <textarea id="texto" name="texto" class="form-control" rows="3" placeholder="Digite aqui o histórico do WhatsApp ou informações relevantes."></textarea>
        <div class="form-text">
          <small class="text-muted">
            <i class="fas fa-info-circle"></i> 
            O nome do operador e a data/hora serão adicionados automaticamente ao salvar.
          </small>
        </div>
      </div>
      <button type="submit" class="btn btn-primary">Adicionar Detalhamento</button>
    </form>

    <h4 class="mt-4">Histórico</h4>
    <div id="followupList">
      {% for follow_up in follow_ups %}
        <div class="card mb-3">
          <div class="card-body">
            <div class="followup-entry">
              <div class="followup-header">
                <strong>{{ follow_up.created_at|date:"d/m/Y H:i" }}:</strong>
              </div>
              <div class="followup-content">
                {{ follow_up.texto|linebreaks }}
              </div>
            </div>
          </div>
        </div>
      {% empty %}
        <div class="card mb-3">
          <div class="card-body">
            <p class="text-muted mb-0">Nenhum Follow-up registrado.</p>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const preSelecionado = {{ pre_selecionado|default:"null"|safe }};
    if (preSelecionado) {
      if(document.getElementById('devedor_id')) document.getElementById('devedor_id').value = preSelecionado.id;
      if(document.getElementById('empresa_id')) document.getElementById('empresa_id').value = preSelecionado.empresa_id || '';
      if(document.getElementById('empresa_nome_fantasia')) document.getElementById('empresa_nome_fantasia').value = preSelecionado.nome_fantasia || 'N/A';
      if(document.getElementById('telefone')) document.getElementById('telefone').value = preSelecionado.telefone || '';
      if(document.getElementById('pesquisa_devedor')) document.getElementById('pesquisa_devedor').value = preSelecionado.nome;
    }
  });
</script>

<!-- ========== MODAL WHATSAPP (templates padrão para outras mensagens) ========== -->
<div class="modal fade" id="modalWhatsapp" tabindex="-1" aria-labelledby="modalWhatsappLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg"><div class="modal-content">
    <div class="modal-header">
      <h5 class="modal-title" id="modalWhatsappLabel">Selecionar mensagem do WhatsApp (templates)</h5>
      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
    </div>
    <div class="modal-body">
      <div class="mb-3">
        <label class="form-label">Enviar para</label>
        <select id="whatsNumeroSelect" class="form-select">
          {% if devedor.telefone1 %}<option value="{{ devedor.telefone1|clean_phone_number }}">{{ devedor.telefone1 }}</option>{% endif %}
          {% if devedor.telefone2 %}<option value="{{ devedor.telefone2|clean_phone_number }}">{{ devedor.telefone2 }}</option>{% endif %}
          {% if devedor.telefone3 %}<option value="{{ devedor.telefone3|clean_phone_number }}">{{ devedor.telefone3 }}</option>{% endif %}
          {% if devedor.telefone4 %}<option value="{{ devedor.telefone4|clean_phone_number }}">{{ devedor.telefone4 }}</option>{% endif %}
          {% if devedor.telefone5 %}<option value="{{ devedor.telefone5|clean_phone_number }}">{{ devedor.telefone5 }}</option>{% endif %}
          {% if devedor.telefone6 %}<option value="{{ devedor.telefone6|clean_phone_number }}">{{ devedor.telefone6 }}</option>{% endif %}
          {% if devedor.telefone7 %}<option value="{{ devedor.telefone7|clean_phone_number }}">{{ devedor.telefone7 }}</option>{% endif %}
          {% if devedor.telefone8 %}<option value="{{ devedor.telefone8|clean_phone_number }}">{{ devedor.telefone8 }}</option>{% endif %}
          {% if devedor.telefone9 %}<option value="{{ devedor.telefone9|clean_phone_number }}">{{ devedor.telefone9 }}</option>{% endif %}
          {% if devedor.telefone10 %}<option value="{{ devedor.telefone10|clean_phone_number }}">{{ devedor.telefone10 }}</option>{% endif %}
        </select>
      </div>

      <div class="btn-group flex-wrap w-100 mb-2" role="group" aria-label="Escolha a mensagem">
        <button type="button" class="btn btn-outline-primary active" data-opt="padrao" onclick="escolherMsg('padrao')">Padrão</button>
        <button type="button" class="btn btn-outline-primary" data-opt="vencidas" onclick="escolherMsg('vencidas')">Vencidas</button>
        <button type="button" class="btn btn-outline-primary" data-opt="a_vencer" onclick="escolherMsg('a_vencer')">A vencer</button>
        <button type="button" class="btn btn-outline-primary" data-opt="vencendo_hoje" onclick="escolherMsg('vencendo_hoje')">Vencendo hoje</button>
        <button type="button" class="btn btn-outline-primary" data-opt="quebra" onclick="escolherMsg('quebra')">Quebra de acordo</button>
        <button type="button" class="btn btn-outline-success" data-opt="proposta" onclick="escolherMsg('proposta')">Proposta de Acordo</button>
      </div>

      <div class="mb-3">
        <label for="msgTemplateEditor" class="form-label fw-semibold">Editar mensagem selecionada</label>
        <textarea id="msgTemplateEditor" class="form-control" rows="8" placeholder="Ajuste o texto antes do envio."></textarea>
        <div class="d-flex flex-wrap justify-content-between align-items-center mt-2 gap-2">
          <small class="text-muted mb-0">As alterações valem somente para este envio e não alteram o template original.</small>
          <div class="d-flex align-items-center gap-2">
            <span id="msgEditorStatus" class="badge bg-secondary">Original</span>
            <button type="button" class="btn btn-outline-primary btn-sm" onclick="salvarEdicaoTemplate()">
              <i class="bi bi-save"></i> Salvar alterações
            </button>
          </div>
        </div>
        <div id="msgEditorFeedback" class="form-text d-none"></div>
      </div>

      <div class="accordion" id="accMsg">
        <div class="accordion-item">
          <h2 class="accordion-header" id="headMsg">
            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseMsg">Pré-visualização do envio</button>
          </h2>
          <div id="collapseMsg" class="accordion-collapse collapse show">
            <div class="accordion-body">
              <pre id="previewMsgText" class="mb-0" style="white-space:pre-wrap;"></pre>
            </div>
          </div>
        </div>
      </div>
      <small class="text-muted d-block mt-2">Nada é enviado automaticamente.</small>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
      <button type="button" class="btn btn-success" onclick="enviarWhats()"><i class="bi bi-whatsapp"></i> Abrir WhatsApp</button>
    </div>
  </div></div>
</div>

<script>
  /* ================== CONFIG ================== */
  // true: recarrega a página após salvar o follow-up
  // false: só insere no "Histórico" (ul#followupList) sem reload
  const HARD_RELOAD_AFTER_POST = false;

  /* ================== MENSAGENS ================== */
  const MSGS_WHATS = {
    vencidas: `{{ msg_vencidas|default_if_none:''|escapejs }}`,
    a_vencer:`{{ msg_a_vencer|default_if_none:''|escapejs }}`,
    padrao:  `{{ msg_padrao|default_if_none:''|escapejs }}`,
    quebra:  `{{ msg_quebra|default_if_none:''|escapejs }}`,
    vencendo_hoje: '' ,
    proposta: ''
  };
  const LABEL_TEMPLATE = { padrao:'Padrão', vencidas:'Vencidas', a_vencer:'A vencer', vencendo_hoje:'Vencendo hoje', quebra:'Quebra de acordo', proposta:'Proposta de Acordo' };
  let ESCOLHA_ATUAL = 'padrao';
  const MSGS_WHATS_EDITADAS = {};
  let EDICAO_PENDENTE = false;

  function getEditorTemplate(){
    return document.getElementById('msgTemplateEditor');
  }
  function textoEditorAtual(){
    const editor = getEditorTemplate();
    if (editor) return editor.value || '';
    return MSGS_WHATS_EDITADAS[ESCOLHA_ATUAL] ?? MSGS_WHATS[ESCOLHA_ATUAL] ?? '';
  }
  function atualizarPreviewMsg(forcedText){
    const texto = forcedText !== undefined ? forcedText : textoEditorAtual();
    const el = document.getElementById('previewMsgText');
    if (el) el.textContent = texto || '';
  }
  function atualizarStatusEditor(){
    const badge = document.getElementById('msgEditorStatus');
    if (!badge) return;
    if (EDICAO_PENDENTE){
      badge.textContent = 'Alterações não salvas';
      badge.className = 'badge bg-warning text-dark';
    } else if (MSGS_WHATS_EDITADAS[ESCOLHA_ATUAL]){
      badge.textContent = 'Personalizado';
      badge.className = 'badge bg-info text-dark';
    } else {
      badge.textContent = 'Original';
      badge.className = 'badge bg-secondary';
    }
  }
  function marcarEdicaoPendente(flag=true){
    EDICAO_PENDENTE = !!flag;
    atualizarStatusEditor();
  }
  function mostrarFeedbackMsg(texto, tipo='ok'){
    const feedback = document.getElementById('msgEditorFeedback');
    if (!feedback) return;
    if (!texto){
      feedback.classList.add('d-none');
      feedback.textContent = '';
      return;
    }
    feedback.textContent = texto;
    feedback.classList.remove('d-none');
    feedback.classList.remove('text-success', 'text-danger');
    if (tipo === 'ok') feedback.classList.add('text-success');
    else if (tipo === 'erro') feedback.classList.add('text-danger');
  }
  function carregarTemplateNoEditor(tipo){
    const editor = getEditorTemplate();
    if (editor){
      const custom = Object.prototype.hasOwnProperty.call(MSGS_WHATS_EDITADAS, tipo) ? MSGS_WHATS_EDITADAS[tipo] : undefined;
      editor.value = (custom ?? MSGS_WHATS[tipo] ?? '');
    }
    marcarEdicaoPendente(false);
    mostrarFeedbackMsg('');
    atualizarPreviewMsg();
  }
  function salvarEdicaoTemplate(){
    const texto = textoEditorAtual();
    MSGS_WHATS_EDITADAS[ESCOLHA_ATUAL] = texto;
    marcarEdicaoPendente(false);
    mostrarFeedbackMsg('Alterações salvas para este envio.');
    atualizarPreviewMsg(texto);
  }

  document.getElementById('msgTemplateEditor')?.addEventListener('input', (event) => {
    marcarEdicaoPendente(true);
    mostrarFeedbackMsg('');
    atualizarPreviewMsg(event.target.value);
  });

  /* ================== UI DO MODAL ================== */
  function escolherMsg(tipo){
    if (tipo === 'vencendo_hoje') atualizarMsgVencendoHoje();
    ESCOLHA_ATUAL = tipo;
    document.querySelectorAll('[data-opt]').forEach(b=>b.classList.remove('active'));
    const bt = document.querySelector(`[data-opt="${tipo}"]`);
    if (bt) bt.classList.add('active');
    carregarTemplateNoEditor(tipo);
  }
  function abrirModalWhats(btn){
    const numero = btn?.getAttribute('data-whats') || '';
    const sel = document.getElementById('whatsNumeroSelect');
    if (sel && numero){
      const opt = [...sel.options].find(o=>o.value===numero);
      if (opt) sel.value = numero;
    }
    escolherMsg('padrao');
    new bootstrap.Modal(document.getElementById('modalWhatsapp')).show();
  }
  // ===== Mensagem "Vencendo hoje"
  function obterCtxEmpresa(){
    const el = document.getElementById('ctx');
    const fantasia = el?.dataset?.empresaFantasia || '';
    const razao    = el?.dataset?.empresaRazao || '';
    return fantasia || razao || '';
  }
  function hojeBR(){
    const d=new Date();
    return String(d.getDate()).padStart(2,'0')+"/"+String(d.getMonth()+1).padStart(2,'0')+"/"+d.getFullYear();
  }
  function parseMoneyBR(txt){ return (txt||'').trim(); }
  function somaVencendoHoje(){
    const alvo = hojeBR();
    let total = 0;
    const toNumber = s=>{ s=(s||'').replace(/[^\d,.-]/g,'').replace(/\./g,'').replace(',', '.'); const n=parseFloat(s); return isNaN(n)?0:n; };
    // Tabela Entrada
    const te = document.getElementById('tblTitulosEntrada');
    if (te) te.querySelectorAll('tbody tr').forEach(tr=>{
      const tds = tr.querySelectorAll('td');
      const venc = (tds[7]?.textContent||'').trim();
      const valor = (tds[10]?.textContent||tds[3]?.textContent||'').trim();
      if (venc === alvo) total += toNumber(valor);
    });
    // Tabela Associados
    const ta = document.getElementById('tblTitulosAssociados');
    if (ta) ta.querySelectorAll('tbody tr').forEach(tr=>{
      const tds = tr.querySelectorAll('td');
      const venc = (tds[6]?.textContent||'').trim();
      const valor = (tds[4]?.textContent||'').trim();
      if (venc === alvo) total += toNumber(valor);
    });
    return total;
  }
  function formatBRL(n){ try{ return new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(n||0);}catch(_){ return `R$ ${Number(n||0).toFixed(2)}`.replace('.',','); } }
  function atualizarMsgVencendoHoje(){
    const credor = obterCtxEmpresa();
    const totalHoje = somaVencendoHoje();
    const valorTxt = formatBRL(totalHoje);
    MSGS_WHATS.vencendo_hoje = `Bom dia\n\nComunicamos que consta valores a serem pagos hoje para o credor ${credor}.\n\nValor da parcela: ${valorTxt}`;
    if (ESCOLHA_ATUAL === 'vencendo_hoje' && !MSGS_WHATS_EDITADAS.vencendo_hoje && !EDICAO_PENDENTE){
      carregarTemplateNoEditor('vencendo_hoje');
    } else if (ESCOLHA_ATUAL === 'vencendo_hoje') {
      atualizarPreviewMsg();
    }
  }

  /* ================== HELPERS ================== */
  function getCookie(name){
    const v = document.cookie.split(';').map(c=>c.trim()).find(c=>c.startsWith(name+'='));
    return v ? decodeURIComponent(v.split('=')[1]) : '';
  }
  function escapeHTML(s){
    return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;');
  }

  /* ================== DETALHAMENTO MANUAL ================== */
  // Intercepta o envio do formulário de detalhamento para adicionar operador e timestamp
  document.getElementById('formDetalhamento')?.addEventListener('submit', function(e) {
    const textarea = document.getElementById('texto');
    const textoOriginal = textarea.value.trim();
    
    if (textoOriginal) {
      const operador = document.getElementById('ctx')?.dataset.user || 'Operador';
      const agora = new Date();
      const dataHora = agora.toLocaleDateString('pt-BR') + ' às ' + agora.toLocaleTimeString('pt-BR', { 
        hour: '2-digit', 
        minute: '2-digit' 
      });
      
      const textoComCabecalho = `[${dataHora}] - ${operador}:\n${textoOriginal}`;
      textarea.value = textoComCabecalho;
    }
  });

  /* ================== PROPOSTA DE ACORDO ================== */
  // Função para abrir modal do WhatsApp para proposta
  function abrirModalWhatsProposta() {
    const textoProposta = document.getElementById('previewInterno').value;
    if (!textoProposta.trim()) {
      alert('Gere uma proposta primeiro antes de enviar via WhatsApp.');
      return;
    }
    
    // Usa o mesmo modal existente, mas com o texto da proposta
    const modal = document.getElementById('modalWhatsapp');
    if (modal) {
      // Atualiza as mensagens para incluir a proposta
      MSGS_WHATS.proposta = textoProposta;
      escolherMsg('proposta');
      new bootstrap.Modal(modal).show();
    }
  }

  // Função para salvar proposta de acordo
  function salvarPropostaAcordo() {
    const textoProposta = document.getElementById('previewInterno').value;
    if (!textoProposta.trim()) {
      alert('Gere uma proposta primeiro antes de salvar.');
      return;
    }

    const operador = document.getElementById('ctx')?.dataset.user || 'Operador';
    const agora = new Date();
    const dataHora = agora.toLocaleDateString('pt-BR') + ' às ' + agora.toLocaleTimeString('pt-BR', { 
      hour: '2-digit', 
      minute: '2-digit' 
    });

    const textoComCabecalho = `[PROPOSTA DE ACORDO - ${dataHora}] - ${operador}:\n\n${textoProposta}`;

    // Salva via AJAX
    const endpoint = "{% url 'adicionar_follow_up' devedor.id %}";
    const csrf = getCookie('csrftoken');
    
    const body = new URLSearchParams({
      'csrfmiddlewaretoken': csrf,
      'texto': textoComCabecalho
    });

    fetch(endpoint, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'X-CSRFToken': csrf },
      body
    })
    .then(response => {
      if (response.ok) {
        alert('Proposta de acordo salva com sucesso!');
        // Adiciona ao histórico sem recarregar a página
        addFollowupToDOM(textoComCabecalho);
      } else {
        alert('Erro ao salvar proposta de acordo.');
      }
    })
    .catch(error => {
      console.error('Erro:', error);
      alert('Erro ao salvar proposta de acordo.');
    });
  }

  /* ================== FOLLOW-UP ================== */
  // Salva o follow-up e retorna uma Promise
  function salvarFollowUpWhats({ texto, numero, tipo }){
    const endpoint = "{% url 'adicionar_follow_up' devedor.id %}";
    const csrf = getCookie('csrftoken');
    const operador = document.getElementById('ctx')?.dataset.user || '';
    const payloadText = `[WHATSAPP • ${tipo}]${operador ? ' (Operador: ' + operador + ')' : ''}\nPara: ${numero}\n\n${texto}`;

    const body = new URLSearchParams({
      'csrfmiddlewaretoken': csrf,
      'texto': payloadText
    });

    return new Promise((resolve) => {
      if (navigator.sendBeacon) {
        const blob = new Blob([body], { type: 'application/x-www-form-urlencoded; charset=UTF-8' });
        navigator.sendBeacon(endpoint, blob);
        setTimeout(resolve, 300); // pequeno atraso p/ persistir
      } else {
        fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type':'application/x-www-form-urlencoded', 'X-CSRFToken': csrf },
          body
        }).finally(resolve);
      }
    });
  }

  // Insere o follow-up no topo da lista sem recarregar
  function addFollowupToDOM(texto){
    const container = document.getElementById('followupList');
    if (!container) return;
    
    const now = new Date();
    const ts = now.toLocaleDateString('pt-BR') + ' ' + now.toLocaleTimeString('pt-BR', { hour:'2-digit', minute:'2-digit' });
    const safe = escapeHTML(texto).replace(/\n/g,'<br>');
    
    const cardDiv = document.createElement('div');
    cardDiv.className = 'card mb-3';
    cardDiv.innerHTML = `
      <div class="card-body">
        <div class="followup-entry">
          <div class="followup-header">
            <strong>${ts}:</strong>
          </div>
          <div class="followup-content">
            ${safe}
          </div>
        </div>
      </div>
    `;
    
    // Remove a mensagem "Nenhum Follow-up registrado" se existir
    const emptyMsg = container.querySelector('.text-muted');
    if (emptyMsg) {
      emptyMsg.closest('.card').remove();
    }
    
    container.insertBefore(cardDiv, container.firstChild);
  }

  /* ================== AÇÃO: ENVIAR WHATS ================== */
  function enviarWhats(){
    const sel = document.getElementById('whatsNumeroSelect');
    const numero = sel ? sel.value : '';
    if (!numero){ alert('Selecione um número válido.'); return; }

    const textoAtual = textoEditorAtual();
    if (!textoAtual.trim()){
      alert('Escreva a mensagem antes de enviar.');
      return;
    }
    const texto = textoAtual;
    const tipo  = LABEL_TEMPLATE[ESCOLHA_ATUAL] || ESCOLHA_ATUAL;

    // Abre a aba já no clique (evita bloqueio de popup)
    const win = window.open('', '_blank');

    // Salva o follow-up e, depois, atualiza a UI ou recarrega
    salvarFollowUpWhats({ texto, numero, tipo }).then(() => {
      const hasList = !!document.getElementById('followupList');
      if (HARD_RELOAD_AFTER_POST || !hasList) {
        setTimeout(()=>location.reload(), 200);
      } else {
        const operador = document.getElementById('ctx')?.dataset.user || '';
        const header = `[WHATSAPP • ${tipo}]${operador ? ' (Operador: ' + operador + ')' : ''}\nPara: ${numero}\n\n`;
        addFollowupToDOM(header + texto);
      }
    });

    // Vai para o WhatsApp
    win.location = `https://wa.me/55${numero}?text=${encodeURIComponent(texto)}`;

    // Fecha o modal
    const modalEl = document.getElementById('modalWhatsapp');
    bootstrap.Modal.getInstance(modalEl)?.hide();
  }
</script>


<!-- Botão Atualizar Devedor (JS) -->
<script>
document.getElementById('btn-atualizar-devedor')?.addEventListener('click', function() {
  fetch("{% url 'consult_api' %}", {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCookie('csrftoken')
    },
    body: JSON.stringify({ devedores: [ {{ devedor.id }} ] })
  })
  .then(resp => resp.json())
  .then(json => {
    if (json.success) { alert('Devedor atualizado com sucesso!'); location.reload(); }
    else { alert('Erro: ' + (json.message || 'Falha na atualização')); }
  })
  .catch(err => { console.error(err); alert('Falha ao comunicar com o servidor.'); });
});
</script>

{% endblock %}
