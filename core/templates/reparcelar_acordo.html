{% extends 'base.html' %}

{% block content %}
<div class="container mt-5">
  <h1 class="text-center mb-3">Reparcelar Acordo</h1>
  <p>Cliente: <b>{{ titulo.devedor.nome }}</b></p>

  <div class="alert alert-info">
    <div><b>Total vencido:</b> R$ {{ total_vencido|floatformat:2 }}</div>
    <div><b>Total a vencer:</b> R$ {{ total_vincendo|floatformat:2 }}</div>
    <div><b>Saldo devedor total:</b> R$ {{ saldo_total|floatformat:2 }}</div>
  </div>

  <form method="post" class="mt-4">
    {% csrf_token %}

    <input type="hidden" id="valor_divida" name="valor_divida" value="{{ saldo_total|floatformat:2 }}">

    <div class="row mb-3">
      <label class="col-sm-4 col-form-label">Valor base do reparcelamento</label>
      <div class="col-sm-8">
        <span id="valor_divida_exibicao"><b>R$ {{ saldo_total|floatformat:2 }}</b></span>
      </div>
    </div>

    <div class="row mb-3">
      <label class="col-sm-4 col-form-label">Valor total de juros/encargos</label>
      <div class="col-sm-8">
        <span><b>R$ {{ juros_totais|floatformat:2 }}</b></span>
        <input type="hidden" id="valor_juros" name="valor_juros" value="{{ juros_totais|floatformat:2 }}">
      </div>
    </div>

    <div class="row mb-3">
      <label class="col-sm-4 col-form-label">Desconto nos Juros (%)</label>
      <div class="col-sm-8">
        <input type="number" step="0.01" id="desconto_juros_percentual" name="desconto_juros_percentual" class="form-control" placeholder="ex.: 20">
        <small class="text-muted">Informe um percentual entre 0 e 100.</small>
      </div>
    </div>

    <div class="row mb-3">
      <label class="col-sm-4 col-form-label">Valor dos Juros com Desconto</label>
      <div class="col-sm-8">
        <input type="number" step="0.01" id="valor_juros_com_desconto" name="valor_juros_com_desconto" class="form-control" readonly value="0.00">
      </div>
    </div>

    <div class="row mb-3">
      <label class="col-sm-4 col-form-label">Valor Total Negociação</label>
      <div class="col-sm-8">
        <input type="number" step="0.01" id="valor_total_negociacao" name="valor_total_negociacao" class="form-control" required>
        <small class="text-muted">Você pode ajustar este total antes de gerar as parcelas.</small>
      </div>
    </div>

    <div class="row mb-3">
      <label class="col-sm-4 col-form-label">Entrada</label>
      <div class="col-sm-8">
        <input type="number" step="0.01" id="entrada" name="entrada" class="form-control" required>
      </div>
    </div>

    <div class="row mb-3">
      <label class="col-sm-4 col-form-label">Quantidade de Parcelas</label>
      <div class="col-sm-8">
        <input type="number" name="qtde_prc" id="qtde_prc" class="form-control" min="1" required>
      </div>
    </div>

    <div class="row mb-3">
      <label class="col-sm-4 col-form-label">Data Entrada</label>
      <div class="col-sm-8">
        <input type="date" name="data_entrada" id="data_entrada" class="form-control" required>
      </div>
    </div>

    <div class="row mb-3">
      <label class="col-sm-4 col-form-label">Vencimento Primeira Parcela</label>
      <div class="col-sm-8">
        <input type="date" name="venc_primeira_parcela" id="venc_primeira_parcela" class="form-control" required>
      </div>
    </div>

    <div class="row mb-3">
      <label class="col-sm-4 col-form-label">Valor por Parcela (sugerido)</label>
      <div class="col-sm-8">
        <input type="number" step="0.01" id="valor_por_parcela" name="valor_por_parcela" class="form-control" readonly>
        <small class="text-muted">Este é o valor médio. Você poderá editar cada parcela na tabela.</small>
      </div>
    </div>

    <div class="row mb-2">
      <label class="col-sm-4 col-form-label">Parcelas</label>
      <div class="col-sm-8">
        <table class="table table-bordered align-middle">
          <thead>
            <tr>
              <th style="width: 90px;">Parcela</th>
              <th style="width: 210px;">Data Vencimento</th>
              <th>Valor (editável)</th>
            </tr>
          </thead>
          <tbody id="parcelas_table_body"></tbody>
        </table>
        <div id="check_total" class="small"></div>
      </div>
    </div>

    <div class="text-center">
      <button type="submit" class="btn btn-success">Salvar Reparcelamento</button>
      <a href="{% url 'detalhes_devedor' acordo_original.id %}" class="btn btn-secondary">Cancelar</a>
    </div>
  </form>
</div>

<script>
  function toISO(d){
    const y=d.getFullYear();
    const m=(d.getMonth()+1).toString().padStart(2,'0');
    const day=d.getDate().toString().padStart(2,'0');
    return `${y}-${m}-${day}`;
  }
  function getNumber(id){ return parseFloat(document.getElementById(id).value || 0); }

  function calcularValores(){
    const base = getNumber('valor_divida');
    const juros = getNumber('valor_juros');
    const perc = getNumber('desconto_juros_percentual');
    if(perc < 0 || perc > 100){ alert('O desconto nos juros deve ser entre 0% e 100%.'); return; }
    const desconto = (perc/100)*juros;
    const jurosComDesconto = Math.max(juros - desconto, 0);
    const total = base + jurosComDesconto;
    document.getElementById('valor_juros_com_desconto').value = jurosComDesconto.toFixed(2);
    document.getElementById('valor_total_negociacao').value = total.toFixed(2);
    atualizarParcelas();
  }

  function atualizarSomaParcelas(){
    const inputs = document.querySelectorAll('input[name="parcelas_valor[]"]');
    let soma = 0; inputs.forEach(i => soma += parseFloat(i.value || 0));
    const totalNeg = getNumber('valor_total_negociacao');
    const entrada = getNumber('entrada');
    const esperado = Math.max(totalNeg - entrada, 0);
    const diff = Math.abs(soma - esperado);
    const el = document.getElementById('check_total');
    el.innerHTML = (diff <= 0.02)
      ? `<span class="text-success">Soma OK: R$ ${soma.toFixed(2)} (esperado R$ ${esperado.toFixed(2)})</span>`
      : `<span class="text-danger">Soma (R$ ${soma.toFixed(2)}) difere do esperado (R$ ${esperado.toFixed(2)}).</span>`;
  }

  function atualizarParcelas(){
    const entrada = getNumber('entrada');
    const totalNeg = getNumber('valor_total_negociacao');
    const qtdePr = parseInt(document.getElementById('qtde_prc').value || 1);
    const firstDue = document.getElementById('venc_primeira_parcela').value;
    const body = document.getElementById('parcelas_table_body');
    body.innerHTML = '';
    if(!firstDue || qtdePr <= 0){ document.getElementById('valor_por_parcela').value=''; atualizarSomaParcelas(); return; }
    const sugerido = (Math.max(totalNeg - entrada,0)/qtdePr);
    document.getElementById('valor_por_parcela').value = isFinite(sugerido)?sugerido.toFixed(2):'';
    const base = new Date(firstDue);
    for(let i=0;i<qtdePr;i++){
      const d = new Date(base); d.setMonth(d.getMonth()+i);
      const iso = toISO(d);
      const linha = `
        <tr>
          <td>${i+1}</td>
          <td>${d.toLocaleDateString('pt-BR')}<input type="hidden" name="parcelas_data[]" value="${iso}"></td>
          <td><div class="input-group input-group-sm"><span class="input-group-text">R$</span>
            <input type="number" step="0.01" class="form-control parcela-input" name="parcelas_valor[]" value="${isFinite(sugerido)?sugerido.toFixed(2):'0.00'}"></div>
          </td>
        </tr>`;
      body.insertAdjacentHTML('beforeend', linha);
    }
    body.querySelectorAll('input[name="parcelas_valor[]"]').forEach(inp=>inp.addEventListener('input', atualizarSomaParcelas));
    atualizarSomaParcelas();
  }

  document.addEventListener('DOMContentLoaded', function(){
    calcularValores();
    document.getElementById('desconto_juros_percentual').addEventListener('input', calcularValores);
    document.getElementById('valor_total_negociacao').addEventListener('input', atualizarParcelas);
    document.getElementById('entrada').addEventListener('input', atualizarParcelas);
    document.getElementById('qtde_prc').addEventListener('input', atualizarParcelas);
    document.getElementById('venc_primeira_parcela').addEventListener('change', atualizarParcelas);

    document.querySelector('form').addEventListener('submit', function(e){
      const totalNeg = getNumber('valor_total_negociacao');
      const entrada = getNumber('entrada');
      const esperado = Math.max(totalNeg - entrada, 0);
      let soma = 0; document.querySelectorAll('input[name="parcelas_valor[]"]').forEach(i=>{ soma += parseFloat(i.value || 0); });
      if(Math.abs(soma - esperado) > 0.02){ e.preventDefault(); alert(`A soma das parcelas (R$ ${soma.toFixed(2)}) precisa bater com o esperado (R$ ${esperado.toFixed(2)}).`); }
    });
  });
</script>
{% endblock %}


