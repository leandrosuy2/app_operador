{% extends 'base.html' %}

{% block content %}
<div class="container mt-5">
    <h3 class="text-center mb-4 fw-bold" style="font-size: 20px; color: #2c3e50; text-transform: uppercase; letter-spacing: 1px;">
    

    <i class="fas fa-users me-2" style="color: #3498db;"></i> Lista de Devedores
</h3>

    <div class="d-flex gap-2 flex-wrap justify-content-start mb-2">
  <span class="badge bg-warning text-dark">Pendente: {{ totals.pendentes|default:0 }}</span>
  <span class="badge bg-info text-dark">Negociado: {{ totals.negociados|default:0 }}</span>
  <span class="badge bg-success">Quitado: {{ totals.quitados|default:0 }}</span>
  <span class="badge bg-secondary">Total: {{ totals.total|default:0 }}</span>
</div>
    <!-- Botão para adicionar novo devedor -->
   
	<div class="container mt-5">
    <div class="text-end mb-3 d-flex justify-content-end gap-2">
        <!-- Botão Consultar API -->
        <button id="consult-api-btn" class="btn btn-sm btn-primary d-flex align-items-center" style="font-size: 14px; padding: 6px 12px;">
            <i class="fas fa-search me-2"></i> Consultar API
        </button>

        <!-- Botão Adicionar Devedor -->
        <a href="{% url 'adicionar_devedor' %}" class="btn btn-sm btn-success d-flex align-items-center" style="font-size: 14px; padding: 6px 12px;">
            <i class="fas fa-user-plus me-2"></i> Adicionar Devedor
        </a>

        <!-- Botão Baixar Modelo -->
        <a href="{% url 'baixar_modelo_devedor' %}" class="btn btn-sm btn-info d-flex align-items-center" style="font-size: 14px; padding: 6px 12px;">
            <i class="fas fa-download me-2"></i> Baixar Modelo
        </a>

        <!-- Botão Importar Devedor -->
        <button class="btn btn-sm btn-primary d-flex align-items-center" style="font-size: 14px; padding: 6px 12px;" data-bs-toggle="modal" data-bs-target="#importarModal">
            <i class="fas fa-file-upload me-2"></i> Importar Devedor
        </button>
    </div>
</div>


    <!-- Modal de Importação -->
    <div class="modal fade" id="importarModal" tabindex="-1" aria-labelledby="importarModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <form method="POST" action="{% url 'importar_devedor' %}" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="importarModalLabel">Importar Devedor</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <label for="arquivo" class="form-label">Selecione a planilha:</label>
                        <input type="file" name="arquivo" id="arquivo" class="form-control" required>
                        <div class="form-text mt-2">
                            Certifique-se de usar o modelo correto para importar.
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary">Importar</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Campo de pesquisa e filtros -->
    <div class="mb-2">
        <form method="get" action="{% url 'listar_devedores' %}" class="d-flex flex-wrap gap-2 align-items-center" style="font-size: 12px;">
            <div class="flex-grow-1">
                <input type="text" name="q" value="{{ query }}" class="form-control form-control-sm" placeholder="Pesquisar por nome, CPF, CNPJ, telefone, etc.">
            </div>
            <div>
                <button type="submit" name="status" value="" class="btn btn-sm {% if not status %}btn-secondary{% else %}btn-outline-secondary{% endif %}" style="font-size: 12px; padding: 4px 8px;">
                    Pesquisar
                </button>
              <button type="submit" name="status" value="Pendente"
  class="btn btn-sm {% if status == 'Pendente' %}btn-warning{% else %}btn-outline-warning{% endif %}">
  Pendente ({{ totals.pendentes|default:0 }})
</button>
<button type="submit" name="status" value="Quitado"
  class="btn btn-sm {% if status == 'Quitado' %}btn-success{% else %}btn-outline-success{% endif %}">
  Quitado ({{ totals.quitados|default:0 }})
</button>
<button type="submit" name="status" value="Negociado"
  class="btn btn-sm {% if status == 'Negociado' %}btn-info{% else %}btn-outline-info{% endif %}">
  Negociado ({{ totals.negociados|default:0 }})
</button>

            </div>
        </form>
    </div>

    <!-- Tabela de devedores -->
    <table class="table table-striped table-bordered text-center table-sm" style="font-size: 0.9rem;">
        <thead class="table-dark">
            <tr>
				<th><input type="checkbox" id="select-all"></th>	
                <th style="padding: 5px;">ID</th>
                <th style="padding: 5px;">Nome</th>
                <th style="padding: 5px;">CPF / CNPJ</th>                
                <th style="padding: 5px;">Empresa</th>
                <th style="padding: 5px;">Título ID</th>
                <th style="padding: 5px;">Telefones</th>
                <th style="padding: 5px;">Status Baixa</th>
                <th style="padding: 5px;">Ações</th>
            </tr>
        </thead>
        <tbody>
            {% if page_obj and page_obj.object_list %}
                {% for devedor in page_obj %}
                <tr>
					<td><input type="checkbox" class="devedor-checkbox" value="{{ devedor.id }}"></td>
                    <td><b>{{ devedor.id }}</b></td>
                    <td class="text-start">
						         <b>
					{% if devedor.nome %}
						{{ devedor.nome }}
					{% elif devedor.nome_fantasia %}
						{{ devedor.nome_fantasia }}
					{% endif %}
				</b>
					</td>

                    <td><b>
						{% if devedor.cpf %}
							{{ devedor.cpf }}
						{% elif devedor.cnpj %}
							{{ devedor.cnpj }}
						{% else %}
							Não informado
						{% endif %}
					</b></td>
                    
                    <td><b>{{ devedor.empresa }}</b></td>
                    <td><b>{{ devedor.titulo_id }}</b></td>
                    <td class="text-start">
                      {% with t1=devedor.telefone1 t2=devedor.telefone2 t3=devedor.telefone3 t4=devedor.telefone4 t5=devedor.telefone5 t6=devedor.telefone6 t7=devedor.telefone7 t8=devedor.telefone8 t9=devedor.telefone9 t10=devedor.telefone10 %}
                        {% firstof t1 t2 t3 t4 t5 t6 t7 t8 t9 t10 as any %}
                        {% if any %}
                          <small>
                            {% if t1 %}<span class="badge bg-light text-dark border">{{ t1 }}</span>{% endif %}
                            {% if t2 %}<span class="badge bg-light text-dark border">{{ t2 }}</span>{% endif %}
                            {% if t3 %}<span class="badge bg-light text-dark border">{{ t3 }}</span>{% endif %}
                            {% if t4 %}<span class="badge bg-light text-dark border">{{ t4 }}</span>{% endif %}
                            {% if t5 %}<span class="badge bg-light text-dark border">{{ t5 }}</span>{% endif %}
                            {% if t6 %}<span class="badge bg-light text-dark border">{{ t6 }}</span>{% endif %}
                            {% if t7 %}<span class="badge bg-light text-dark border">{{ t7 }}</span>{% endif %}
                            {% if t8 %}<span class="badge bg-light text-dark border">{{ t8 }}</span>{% endif %}
                            {% if t9 %}<span class="badge bg-light text-dark border">{{ t9 }}</span>{% endif %}
                            {% if t10 %}<span class="badge bg-light text-dark border">{{ t10 }}</span>{% endif %}
                          </small>
                        {% else %}
                          <small class="text-muted">—</small>
                        {% endif %}
                      {% endwith %}
                    </td>
                   {# templates/devedores_listar.html #}
<td><b>
  {% if devedor.status_baixa == "Pendente" %}
    <span class="badge bg-warning text-dark" style="font-size:10px;">Pendente</span>
  {% elif devedor.status_baixa == "Quitado" %}
    <span class="badge bg-success" style="font-size:10px;">Quitado</span>
  {% elif devedor.status_baixa == "Negociado" %}
    <span class="badge bg-info" style="font-size:10px;">Negociado</span>
  {% else %}
    <span class="badge bg-secondary" style="font-size:10px;">Desconhecido</span>
  {% endif %}

{% if devedor.titulo_id and devedor.status_baixa != "Pendente" %}
<a href="#"
   class="btn btn-sm btn-outline-primary ms-2 link-ver-anexos"
   data-titulo-id="{{ devedor.titulo_id }}"
   title="Comprovante" style="font-size:10px; padding:2px 6px;">
  <i class="fas fa-receipt me-1"></i> Comprovante
</a>
{% endif %}


</b></td>

                    <td>
                        <div class="d-flex justify-content-center gap-1">
						
						
							{% if devedor.titulo_id %}
  <a href="{% url 'detalhes_devedor' devedor.titulo_id %}" target="_blank" class="btn btn-sm btn-info">Visualizar</a>
{% else %}
  <button class="btn btn-sm btn-info" disabled>Visualizar</button>
{% endif %}
                            
                            <a href="{% url 'editar_devedor' devedor.id %}" class="btn btn-sm btn-primary" style="font-size: 10px; padding: 2px 6px;">
                                <i class="fas fa-edit"></i> Editar
                            </a>
                            <a href="{% url 'excluir_devedor' devedor.id %}" class="btn btn-sm btn-danger" style="font-size: 10px; padding: 2px 6px;">
                                <i class="fas fa-trash"></i> Excluir
                            </a>
                            <a href="{% url 'listar_titulos_por_devedor' devedor.id %}" class="btn btn-sm btn-info" style="font-size: 10px; padding: 2px 6px;">
                                <i class="fas fa-eye"></i> Ver Títulos
                            </a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            {% else %}
            <tr>
                <td colspan="8" class="text-center">Nenhum devedor encontrado.</td>
            </tr>
            {% endif %}
        </tbody>
    </table>

    <!-- Paginação -->
   <div class="d-flex justify-content-between align-items-center mt-2" style="font-size: 12px;">
    <div>
        {% if page_obj.has_previous %}
            <a href="?page=1{% if query %}&q={{ query }}{% endif %}{% if status %}&status={{ status }}{% endif %}" 
               class="btn btn-sm btn-primary" style="font-size: 10px; padding: 2px 6px;">
                <i class="fas fa-angle-double-left"></i> Primeira
            </a>
            <a href="?page={{ page_obj.previous_page_number }}{% if query %}&q={{ query }}{% endif %}{% if status %}&status={{ status }}{% endif %}" 
               class="btn btn-sm btn-secondary" style="font-size: 10px; padding: 2px 6px;">
                <i class="fas fa-angle-left"></i> Anterior
            </a>
        {% endif %}
    </div>
    <div>
        <span>Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>
    </div>
    <div>
        {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}{% if query %}&q={{ query }}{% endif %}{% if status %}&status={{ status }}{% endif %}" 
               class="btn btn-sm btn-secondary" style="font-size: 10px; padding: 2px 6px;">
                Próxima <i class="fas fa-angle-right"></i>
            </a>
            <a href="?page={{ page_obj.paginator.num_pages }}{% if query %}&q={{ query }}{% endif %}{% if status %}&status={{ status }}{% endif %}" 
               class="btn btn-sm btn-primary" style="font-size: 10px; padding: 2px 6px;">
                Última <i class="fas fa-angle-double-right"></i>
            </a>
        {% endif %}
    </div>
</div>
<script>
    document.getElementById('select-all').addEventListener('change', function() {
        let checkboxes = document.querySelectorAll('.devedor-checkbox');
        checkboxes.forEach(checkbox => checkbox.checked = this.checked);
    });

    document.getElementById('consult-api-btn').addEventListener('click', function() {
        let selectedDevedores = [];
        let checkboxes = document.querySelectorAll('.devedor-checkbox:checked');
        checkboxes.forEach(checkbox => selectedDevedores.push(checkbox.value));

        if (selectedDevedores.length === 0) {
            alert('Selecione pelo menos um devedor para consultar a API.');
            return;
        }

        fetch('{% url "consult_api" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({devedores: selectedDevedores})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Dados atualizados com sucesso.');
                window.location.reload();
            } else {
                alert('Erro ao atualizar dados: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Erro ao consultar a API.');
        });
    });
</script>
<div class="modal fade" id="modalAnexos" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Comprovantes do Título <span id="maTituloId"></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body"><div id="maBody" class="py-2 text-muted">—</div></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', function () {
  const modalEl = document.getElementById('modalAnexos');
  const titleSpan = document.getElementById('maTituloId');
  const bodyDiv = document.getElementById('maBody');
  const modal = new bootstrap.Modal(modalEl, {backdrop:true, keyboard:true});

  // Failsafe: remove backdrops órfãos ao fechar
  modalEl.addEventListener('hidden.bs.modal', () => {
    document.body.classList.remove('modal-open');
    document.querySelectorAll('.modal-backdrop').forEach(b => b.remove());
  });

  document.addEventListener('click', async function (ev) {
    const a = ev.target.closest('a.link-ver-anexos');
    if (!a) return;
    ev.preventDefault();

    const id = a.dataset.tituloId;
    titleSpan.textContent = '#'+id;
    bodyDiv.innerHTML = '<div class="text-muted">Carregando…</div>';

    try {
      const url = "{% url 'titulo_anexos_json' 0 %}".replace('/0/','/'+id+'/');
      const r = await fetch(url, {credentials:'same-origin'});
      if (!r.ok) throw new Error('HTTP '+r.status);
      const data = await r.json();

      if (!data.anexos || !data.anexos.length) {
        bodyDiv.innerHTML = '<div class="alert alert-warning mb-0">Nenhum comprovante anexado.</div>';
      } else {
        bodyDiv.innerHTML = `<ul class="list-group">${
          data.anexos.map(x=>{
            const kb = x.size ? ` <small class="text-muted">(${(x.size/1024).toFixed(1)} KB)</small>` : '';
            const dt = x.date ? ` <small class="text-muted">— ${x.date}</small>` : '';
            return `<li class="list-group-item d-flex justify-content-between align-items-center">
                      <span>${x.name}${kb}${dt}</span>
                      <span class="d-flex gap-2">
                        <a class="btn btn-sm btn-outline-primary" href="${x.url}" target="_blank" rel="noopener">Abrir</a>
                        <a class="btn btn-sm btn-outline-secondary" href="${x.url}" download>Baixar</a>
                      </span>
                    </li>`;
          }).join('')}</ul>`;
      }
    } catch (e) {
      console.error(e);
      bodyDiv.innerHTML = '<div class="alert alert-danger mb-0">Erro ao carregar anexos.</div>';
    }
    modal.show();
  });
});
</script>



{% endblock %}
