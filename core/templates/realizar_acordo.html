{% extends 'base.html' %}

{% block content %}
<div class="container mt-5">
  <h1 class="text-center mb-3">Realizar Acordo</h1>
  <p>Nome do cliente: <b>{{ titulo.devedor.nome }}</b></p>

  <form method="post" class="mt-4">
    {% csrf_token %}

    <!-- Valor da Dívida -->
    <div class="row mb-3">
      <label class="col-sm-4 col-form-label">Valor da Dívida</label>
      <div class="col-sm-8">
        <span id="valor_divida_exibicao"><b>R$ {{ titulo.valor|floatformat:2 }}</b></span>
        <input type="hidden" id="valor_divida" name="valor_divida" value="{{ titulo.valor|floatformat:2 }}">
      </div>
    </div>

    <!-- Data de Vencimento Original -->
    <div class="row mb-3">
      <label class="col-sm-4 col-form-label">Data de Vencimento</label>
      <div class="col-sm-8">
        <span id="data_vencimento_exibicao"><b>{{ data_vencimento_formatada }}</b></span>
        <input type="hidden" id="data_vencimento" name="data_vencimento" value="{{ data_vencimento_formatada }}">
      </div>
    </div>

    <!-- Juros Totais -->
    <div class="row mb-3">
      <label class="col-sm-4 col-form-label">Valor total dos juros</label>
      <div class="col-sm-8">
        <span><b>R$ {{ juros_totais|floatformat:2 }}</b></span>
        <input type="hidden" id="valor_juros" name="valor_juros" value="{{ juros_totais|floatformat:2 }}">
      </div>
    </div>

    <!-- Desconto em Juros -->
    <div class="row mb-3">
      <label class="col-sm-4 col-form-label">Desconto nos Juros (%)</label>
      <div class="col-sm-8">
        <input type="number" step="0.01" id="desconto_juros_percentual" name="desconto_juros_percentual" class="form-control" placeholder="ex.: 20">
        <small class="text-muted">Informe um percentual entre 0 e 100.</small>
      </div>
    </div>

    <!-- Resultado: Juros com Desconto -->
    <div class="row mb-3">
      <label class="col-sm-4 col-form-label">Valor dos Juros com Desconto</label>
      <div class="col-sm-8">
        <input type="number" step="0.01" id="valor_juros_com_desconto" name="valor_juros_com_desconto" class="form-control" readonly value="0.00">
      </div>
    </div>

    <!-- Dívida com Juros (após desconto) -->
    <div class="row mb-3">
      <label class="col-sm-4 col-form-label">Valor da dívida com desconto nos Juros</label>
      <div class="col-sm-8">
        <input type="number" step="0.01" id="valor_total_com_juros" name="valor_total_com_juros" class="form-control" readonly>
      </div>
    </div>

    <!-- Valor Total da Negociação (pode ser ajustado) -->
    <div class="row mb-3">
      <label class="col-sm-4 col-form-label">Valor Total Negociação</label>
      <div class="col-sm-8">
        <input type="number" step="0.01" id="valor_total_negociacao" name="valor_total_negociacao" class="form-control" required>
        <small class="text-muted">Você pode ajustar este total antes de gerar as parcelas.</small>
      </div>
    </div>

    <!-- Entrada -->
    <div class="row mb-3">
      <label class="col-sm-4 col-form-label">Entrada</label>
      <div class="col-sm-8">
        <input type="number" step="0.01" id="entrada" name="entrada" class="form-control" required>
      </div>
    </div>

    <!-- Quantidade de Parcelas -->
    <div class="row mb-3">
      <label class="col-sm-4 col-form-label">Quantidade de Parcelas</label>
      <div class="col-sm-8">
        <input type="number" name="qtde_prc" id="qtde_prc" class="form-control" min="1" required>
      </div>
    </div>

    <!-- Valor por Parcela (sugerido; readonly) -->
    <div class="row mb-3">
      <label class="col-sm-4 col-form-label">Valor por Parcela (sugerido)</label>
      <div class="col-sm-8">
        <input type="number" step="0.01" id="valor_por_parcela" name="valor_por_parcela" class="form-control" readonly>
        <small class="text-muted">Este é apenas o valor médio. Você poderá editar cada parcela na tabela abaixo.</small>
      </div>
    </div>

    <!-- Datas -->
    <div class="row mb-3">
      <label class="col-sm-4 col-form-label">Data Entrada</label>
      <div class="col-sm-8">
        <input type="date" name="data_entrada" id="data_entrada" class="form-control" required>
      </div>
    </div>

    <div class="row mb-3">
      <label class="col-sm-4 col-form-label">Vencimento Primeira Parcela</label>
      <div class="col-sm-8">
        <input type="date" name="venc_primeira_parcela" id="venc_primeira_parcela" class="form-control" required>
      </div>
    </div>

    <!-- Contato -->
    <div class="row mb-3">
      <label class="col-sm-4 col-form-label">Telefone</label>
      <div class="col-sm-8">
        <input type="text" name="contato" class="form-control" required>
      </div>
    </div>

    <!-- Texto do acordo -->
    <div class="row mb-3">
      <div class="col">
        <p>
          <strong>ACORDO EXTRAJUDICIAL DE RENEGOCIAÇÃO DE DÍVIDA:</strong><br>
          Eu, <span id="devedor_nome">{{ titulo.devedor.nome }}</span>, portador do CPF/CNPJ
          <span id="devedor_cpf">
            {% if titulo.devedor.cpf %}{{ titulo.devedor.cpf }}{% else %}{{ titulo.devedor.cnpj }}{% endif %}
          </span>, confirmo a <strong>renegociação da dívida</strong> em favor da empresa
          <span id="empresa_nome">{{ titulo.devedor.empresa.razao_social }}</span>, CNPJ
          <span id="empresa_cnpj">{{ titulo.devedor.empresa.cnpj }}</span>.
          Este acordo seguirá as condições do CONTRATO DE CONFISSÃO E RENEGOCIAÇÃO DE DÍVIDA que será enviado após a confirmação.
          <br><br><strong>Data da Entrada:</strong> <span id="texto_data_entrada"><b>-</b></span><br>
          <strong>Entrada:</strong> <span id="texto_entrada"><b>R$ 0,00</b></span><br>
          <strong>Parcelas:</strong> <span id="texto_parcelas"><b>0x — total R$ 0,00</b></span>
        </p>
      </div>
    </div>

    <!-- Tabela de Parcelas (editáveis) -->
    <div class="row mb-2">
      <label class="col-sm-4 col-form-label">Parcelas</label>
      <div class="col-sm-8">
        <table class="table table-bordered align-middle">
          <thead>
            <tr>
              <th style="width: 90px;">Parcela</th>
              <th style="width: 210px;">Data Vencimento</th>
              <th>Valor (editável)</th>
            </tr>
          </thead>
          <tbody id="parcelas_table_body">
            <!-- preenchido via JS -->
          </tbody>
        </table>
        <div id="check_total" class="small"></div>
        <small class="text-muted">
          Dica: ajuste os valores livremente; a <b>soma</b> deve bater com <b>(Total Negociação – Entrada)</b>.
        </small>
      </div>
    </div>

    <!-- Confirmação -->
    <div class="row mb-4">
      <div class="col">
        <p>
          O Sr/Sra <b>{{ titulo.devedor.nome }}</b> confirma o acordo <strong>SIM</strong> ou <strong>NÃO</strong>?
        </p>
      </div>
    </div>

    <!-- Botões -->
    <div class="text-center">
      <button type="submit" class="btn btn-success">Salvar Acordo</button>
      <a href="{% url 'titulos_listar' %}" class="btn btn-secondary">Cancelar</a>
    </div>
  </form>
</div>

<script>
  // ---------- Helpers ----------
  function toISO(d){
    const y = d.getFullYear();
    const m = (d.getMonth()+1).toString().padStart(2,'0');
    const day = d.getDate().toString().padStart(2,'0');
    return `${y}-${m}-${day}`;
  }
  function getNumber(id){
    return parseFloat(document.getElementById(id).value || 0);
  }

  // ---------- Cálculos principais ----------
  function calcularValores(){
    const tituloValor = getNumber('valor_divida');
    const juros       = getNumber('valor_juros');
    const perc        = getNumber('desconto_juros_percentual');

    if(perc < 0 || perc > 100){
      alert("O desconto nos juros deve ser entre 0% e 100%.");
      return;
    }
    const desconto = (perc/100)*juros;
    const jurosComDesconto = Math.max(juros - desconto, 0);
    const totalComJuros    = tituloValor + jurosComDesconto;

    document.getElementById('valor_juros_com_desconto').value = jurosComDesconto.toFixed(2);
    document.getElementById('valor_total_com_juros').value    = totalComJuros.toFixed(2);
    document.getElementById('valor_total_negociacao').value   = totalComJuros.toFixed(2);

    atualizarParcelas();
  }

  function atualizarTextoAcordo(){
    const entrada    = getNumber('entrada');
    const qtdeParc   = parseInt(document.getElementById('qtde_prc').value || 0);
    const dataEntrada= document.getElementById('data_entrada').value;

    let dataFormatada = '-';
    if(dataEntrada){
      const p = dataEntrada.split('-');
      dataFormatada = `${p[2]}/${p[1]}/${p[0]}`;
    }

    document.getElementById('texto_entrada').innerText     = `R$ ${entrada.toFixed(2)}`;
    document.getElementById('texto_parcelas').innerText    = `${qtdeParc}x — total será definido pela soma das parcelas`;
    document.getElementById('texto_data_entrada').innerText= dataFormatada;
  }

  function atualizarSomaParcelas(){
    const inputs = document.querySelectorAll('input[name="parcelas_valor[]"]');
    let soma = 0;
    inputs.forEach(i => { soma += parseFloat(i.value || 0); });

    const totalNeg = getNumber('valor_total_negociacao');
    const entrada  = getNumber('entrada');
    const esperado = Math.max(totalNeg - entrada, 0);
    const diff     = Math.abs(soma - esperado);

    const el = document.getElementById('check_total');
    if(diff <= 0.02){
      el.innerHTML = `<span class="text-success">Soma das parcelas OK: R$ ${soma.toFixed(2)} (esperado R$ ${esperado.toFixed(2)})</span>`;
    }else{
      el.innerHTML = `<span class="text-danger">A soma (R$ ${soma.toFixed(2)}) difere do esperado (R$ ${esperado.toFixed(2)}).</span>`;
    }

    // Atualiza resumo
    const qtdeParc = parseInt(document.getElementById('qtde_prc').value || 0);
    document.getElementById('texto_parcelas').innerText = `${qtdeParc}x — total R$ ${soma.toFixed(2)}`;
  }

  function atualizarParcelas(){
    const entrada    = getNumber('entrada');
    const totalNeg   = getNumber('valor_total_negociacao');
    const qtdeParc   = parseInt(document.getElementById('qtde_prc').value || 1);
    const firstDue   = document.getElementById('venc_primeira_parcela').value;

    const body = document.getElementById('parcelas_table_body');
    body.innerHTML = '';

    if(!firstDue || qtdeParc <= 0){
      document.getElementById('valor_por_parcela').value = '';
      atualizarSomaParcelas();
      atualizarTextoAcordo();
      return;
    }

    // valor médio sugerido
    const sugerido = (Math.max(totalNeg - entrada,0) / qtdeParc);
    document.getElementById('valor_por_parcela').value = isFinite(sugerido) ? sugerido.toFixed(2) : '';

    const base = new Date(firstDue);
    for(let i=0;i<qtdeParc;i++){
      const d = new Date(base); d.setMonth(d.getMonth()+i);
      const iso = toISO(d);
      const linha = `
        <tr>
          <td>${i+1}</td>
          <td>
            ${d.toLocaleDateString('pt-BR')}
            <input type="hidden" name="parcelas_data[]" value="${iso}">
          </td>
          <td>
            <div class="input-group input-group-sm">
              <span class="input-group-text">R$</span>
              <input type="number" step="0.01" class="form-control parcela-input"
                     name="parcelas_valor[]" value="${isFinite(sugerido)?sugerido.toFixed(2):'0.00'}">
            </div>
          </td>
        </tr>`;
      body.insertAdjacentHTML('beforeend', linha);
    }

    body.querySelectorAll('input[name="parcelas_valor[]"]').forEach(inp=>{
      inp.addEventListener('input', atualizarSomaParcelas);
    });

    atualizarSomaParcelas();
    atualizarTextoAcordo();
  }

  function recalcularComBaseNegociacao(){
    // reconstroi a grade quando o total muda
    atualizarParcelas();
  }

  // ---------- Eventos ----------
  document.addEventListener('DOMContentLoaded', function(){
    // Inicializa com valores calculados
    calcularValores();

    document.getElementById('desconto_juros_percentual').addEventListener('input', calcularValores);
    document.getElementById('valor_total_negociacao').addEventListener('input', recalcularComBaseNegociacao);

    document.getElementById('entrada').addEventListener('input', atualizarParcelas);
    document.getElementById('qtde_prc').addEventListener('input', atualizarParcelas);
    document.getElementById('venc_primeira_parcela').addEventListener('change', atualizarParcelas);

    document.getElementById('entrada').addEventListener('input', atualizarTextoAcordo);
    document.getElementById('data_entrada').addEventListener('change', atualizarTextoAcordo);

    // Validação final no submit (soma das parcelas vs esperado)
    document.querySelector('form').addEventListener('submit', function(e){
      const totalNeg = getNumber('valor_total_negociacao');
      const entrada  = getNumber('entrada');
      const esperado = Math.max(totalNeg - entrada, 0);

      let soma = 0;
      document.querySelectorAll('input[name="parcelas_valor[]"]').forEach(i=>{
        soma += parseFloat(i.value || 0);
      });

      if(Math.abs(soma - esperado) > 0.02){
        e.preventDefault();
        alert(`A soma das parcelas (R$ ${soma.toFixed(2)}) precisa bater com o esperado (R$ ${esperado.toFixed(2)}). Ajuste antes de salvar.`);
      }
    });
  });
</script>
{% endblock %}
