{% extends 'base.html' %}

{% block content %}
<div class="container mt-5">
    <h3 class="text-center mb-4 fw-bold" style="font-size: 22px; color: #3498db; text-transform: uppercase; letter-spacing: 1px;">
    <i class="fas fa-building me-2" style="color: #2980b9;"></i> Lista de Empresas
</h3>

    <div class="mb-3 d-flex justify-content-between">
        <form method="GET" class="d-flex">
            <input type="text" name="q" class="form-control form-control-sm" placeholder="Pesquisar..." value="{{ query }}">
            <button type="submit" class="btn btn-sm btn-primary">Pesquisar</button>
        </form>
        <a href="{% url 'adicionar_empresa' %}" class="btn btn-sm btn-success">Adicionar Empresa</a>
    </div>
    <table class="table table-striped table-bordered text-center table-sm" style="font-size: 0.9rem;">
        <thead>
            <tr>
                <th>ID</th>
                <th>Razão Social</th>
                <th>Nome Fantasia</th>
                <th>CNPJ</th>
				<th>Status</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody>
            {% for empresa in page_obj %}
             <tr {% if not empresa.status_empresa %}class="bg-warning text-dark"{% endif %}>
                <td><b>{{ empresa.id }}</b></td>
                <td><b>{{ empresa.razao_social }}</b></td>
                <td><b>{{ empresa.nome_fantasia }}</b></td>
                <td><b>{{ empresa.cnpj }}</b></td>
				
				 <td>
    <span class="status-text fw-bold {% if empresa.status_empresa %}text-success{% else %}text-danger{% endif %}">
        {% if empresa.status_empresa %}Ativada{% else %}Desativada{% endif %}
    </span>
    <button type="button" class="btn btn-sm toggle-status ms-2"
        data-url="{% url 'alterar_status_empresa' empresa.id %}"
        data-id="{{ empresa.id }}"
        style="min-width: 80px;"
    >
        {% if empresa.status_empresa %}
            Desativar
        {% else %}
            Ativar
        {% endif %}
    </button>
	<script>
document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll(".toggle-status").forEach(button => {
        button.addEventListener("click", function () {
            let url = this.getAttribute("data-url");
            let buttonElement = this;
            let statusText = buttonElement.parentElement.querySelector(".status-text");
            
            fetch(url, {
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}",
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (data.status_empresa) {
                        statusText.textContent = "Ativada";
                        statusText.classList.remove("text-danger");
                        statusText.classList.add("text-success");
                        buttonElement.textContent = "Desativar";
                        buttonElement.classList.remove("btn-success");
                        buttonElement.classList.add("btn-danger");
                    } else {
                        statusText.textContent = "Desativada";
                        statusText.classList.remove("text-success");
                        statusText.classList.add("text-danger");
                        buttonElement.textContent = "Ativar";
                        buttonElement.classList.remove("btn-danger");
                        buttonElement.classList.add("btn-success");
                    }
                    
                    // Atualiza a página após 1 segundo
                    setTimeout(() => location.reload(), 1000);
                } else {
                    alert("Erro ao alterar o status.");
                }
            })
            .catch(error => console.error("Erro:", error));
        });
    });
});
</script>

</td>



                <td>
					<!-- Botão para Contrato -->
					<a href="{% url 'gerar_contrato_lojista' empresa.id %}" class="btn btn-sm btn-warning" target="_blank">
						<i class="fas fa-file-signature"></i> Contrato
					</a>
					
					<!-- Botão para Ficha
					<a href="{% url 'gerar_ficha_lojista' empresa.id %}" class="btn btn-sm btn-primary" target="_blank">
						<i class="fas fa-file-alt"></i> Ficha
					</a>
					 -->
					<!-- Botão para Editar -->
					<a href="{% url 'editar_empresa' empresa.id %}" class="btn btn-sm btn-success">
						<i class="fas fa-edit"></i> Editar
					</a>
					
					<!-- Botão para Excluir -->
					<a href="{% url 'excluir_empresa' empresa.id %}" class="btn btn-sm btn-danger">
						<i class="fas fa-trash-alt"></i> Excluir
					</a>
				</td>

            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="d-flex justify-content-between align-items-center">
        <div>
            {% if page_obj.has_previous %}
                <a href="?page=1&{% if query %}q={{ query }}{% endif %}" class="btn btn-sm btn-primary">Primeira</a>
                <a href="?page={{ page_obj.previous_page_number }}&{% if query %}q={{ query }}{% endif %}" class="btn btn-sm btn-secondary">Anterior</a>
            {% endif %}
        </div>
        <div>
            <span class="fw-bold">Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>
        </div>
        <div>
            {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}&{% if query %}q={{ query }}{% endif %}" class="btn btn-sm btn-secondary">Próxima</a>
                <a href="?page={{ page_obj.paginator.num_pages }}&{% if query %}q={{ query }}{% endif %}" class="btn btn-sm btn-primary">Última</a>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
